<html>
<head><meta charset="utf-8"><title>Map type, hashmap with sepref · General · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/202961-General/index.html">General</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html">Map type, hashmap with sepref</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="313065778"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313065778" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Valentin Springsklee <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313065778">(Nov 30 2022 at 13:59)</a>:</h4>
<p>Hello. I am using the imperative refinement framework and sepref. I have a question regarding the use of the map type <code>'a ⇒ 'b option</code> and the use of hashmaps in imperative HOL code. I defined a monadic function that maps a natural number to each member of a specified set,<code>definition compute_scores :: "'a set ⇒ 'a Profile_List ⇒ ('a ⇀ nat) nres" </code>. The function is can be refined to imperative HOL with sepref using the hashmap implmentation from the imperative collections framework.  I now want to define a separate function that takes a map and returns the maximum of all values. My algorithmic Idea is something like this: <a href="/user_uploads/14278/q5GmcL7RbOyZzU6IEzOFLFMK/Bildschirmfoto_2022-11-30_14-56-50.png">Bildschirmfoto_2022-11-30_14-56-50.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/14278/q5GmcL7RbOyZzU6IEzOFLFMK/Bildschirmfoto_2022-11-30_14-56-50.png" title="Bildschirmfoto_2022-11-30_14-56-50.png"><img src="/user_uploads/14278/q5GmcL7RbOyZzU6IEzOFLFMK/Bildschirmfoto_2022-11-30_14-56-50.png"></a></div><p>I can't synthesize imperative HOL code using sepref. I think, I cannot use the dom function, neither the Option.the operator. How can I access the values in the map, especially with sepref in mind?</p>



<a name="313066729"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313066729" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313066729">(Nov 30 2022 at 14:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="505164">Valentin Springsklee</span> has marked this topic as resolved.</p>



<a name="313066807"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313066807" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313066807">(Nov 30 2022 at 14:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="505164">Valentin Springsklee</span> has marked this topic as unresolved.</p>



<a name="313068478"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313068478" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313068478">(Nov 30 2022 at 14:11)</a>:</h4>
<p>in which step does sepref fail?</p>



<a name="313068716"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313068716" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313068716">(Nov 30 2022 at 14:12)</a>:</h4>
<p>To test if there is some missing precondition or some missing function:</p>
<div class="codehilite" data-code-language="Isabelle"><pre><span></span><code><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_keep</span><span class="w"></span>
<span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_trans_keep</span><span class="w"></span>
<span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_trans_step_keep</span><span class="w"></span>
<span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_side_unfold</span><span class="w"></span>
</code></pre></div>



<a name="313068867"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313068867" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313068867">(Nov 30 2022 at 14:13)</a>:</h4>
<p>To test if some identification fails:</p>
<div class="codehilite" data-code-language="Isabelle"><pre><span></span><code><span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_preproc</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_cons_init</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_id</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_monadify</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_opt_init</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_trans</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_opt</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_cons_solve</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_cons_solve</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_cons_solve_cp</span><span class="w"></span>
<span class="w">  </span><span class="kp">apply</span><span class="w"> </span><span class="n">sepref_dbg_constraints</span><span class="w"></span>
</code></pre></div>



<a name="313070834"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313070834" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313070834">(Nov 30 2022 at 14:22)</a>:</h4>
<p><code>hm_it_has_next</code> and <code>hm_it_init </code> seem to exist for the purpose of iterating</p>



<a name="313070946"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313070946" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313070946">(Nov 30 2022 at 14:23)</a>:</h4>
<p>but I don't know if there is a proper setup</p>



<a name="313071302"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313071302" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Valentin Springsklee <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313071302">(Nov 30 2022 at 14:24)</a>:</h4>
<p>Hello, thanks for the quick reply! So, we have</p>
<p><code>sepref_definition tryitmap 
  is " scoremax" :: "((hm.assn (nat_assn) (nat_assn))⇧k →⇩a (nat_assn))"
  unfolding scoremax_def[abs_def]</code></p>
<p>Sepref fails in the trans phase. <code>sepref_dbg_trans_keep</code> promts "Phase Translation steps <br>
*** Wrong number of produced goals" . And after applying <code>sepref_dbg_trans_step_keep</code>, Phase Apply rule <br>
*** Phase tactic failed is promted. Can it be, that dom and ran</p>



<a name="313073008"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313073008" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313073008">(Nov 30 2022 at 14:32)</a>:</h4>
<p>Then you have to look at the first goal (I suggest using <code>subgoal premises p</code>): If the goal contains a precondition, then the proof of the precondition failed. If it contains a function to synthesize, then some rule is missing</p>



<a name="313073849"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313073849" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Valentin Springsklee <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313073849">(Nov 30 2022 at 14:36)</a>:</h4>
<p>Ok thank you! after applying <code>subgoal premise p</code>, i get <code>hn_refine (hn_ctxt (hm.assn nat_assn nat_assn) x_ xi_) (m' x_ xi_) (Γ'' x_ xi_)
     (Rh x_ xi_) (RETURN (dom x_))</code>. I have had that error before using the dom function in a command (not assertion). Do you have a general tip how to iterate over any (finite) map?</p>



<a name="313075262"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313075262" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313075262">(Nov 30 2022 at 14:42)</a>:</h4>
<p>That indicate that sepref does not know what to do with dom</p>



<a name="313075868"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313075868" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313075868">(Nov 30 2022 at 14:45)</a>:</h4>
<p>I have never tried to iterate over finite maps (in my use case, I can just iterate over all values up to the maximum)</p>



<a name="313075965"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313075965" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mathias Fleury <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313075965">(Nov 30 2022 at 14:45)</a>:</h4>
<p>I would search for all theorems involving hm_it_has_next (find_theorems!) to see if it used anywhere else</p>



<a name="313076556"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/202961-General/topic/Map%20type%2C%20hashmap%20with%20sepref/near/313076556" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Valentin Springsklee <a href="http://isabelle.systems/zulip-archive/stream/202961-General/topic/Map.20type.2C.20hashmap.20with.20sepref.html#313076556">(Nov 30 2022 at 14:48)</a>:</h4>
<p>Thank you! That is a great tip. I have wondered about iterators.</p>



<hr><p>Last updated: Feb 22 2026 at 20:30 UTC</p>
</html>