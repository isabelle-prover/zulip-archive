<html>
<head><meta charset="utf-8"><title>[isabelle] Declaring a type of polymorphic fixed-length l... · Mirror: Isabelle Users Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/index.html">Mirror: Isabelle Users Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Declaring.20a.20type.20of.20polymorphic.20fixed-length.20l.2E.2E.2E.html">[isabelle] Declaring a type of polymorphic fixed-length l...</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="411193003"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Declaring%20a%20type%20of%20polymorphic%20fixed-length%20l.../near/411193003" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Declaring.20a.20type.20of.20polymorphic.20fixed-length.20l.2E.2E.2E.html#411193003">(Jan 04 2024 at 13:56)</a>:</h4>
<p>From: Dominic Mulligan &lt;<a href="mailto:cl-isabelle-users@lists.cam.ac.uk">cl-isabelle-users@lists.cam.ac.uk</a>&gt;<br>
Hi,</p>
<p>Is there any way to declare polymorphic lists with a known-length, i.e.,<br>
something of the following form:</p>
<div class="codehilite" data-code-language="Isabelle"><pre><span></span><code><span class="kn">typedef</span><span class="w"> </span><span class="o">(</span><span class="kp">overloaded</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n n-Type">'a</span><span class="o">,</span><span class="w"> </span><span class="n n-Type">'b</span><span class="o">::</span><span class="s">‹{len}›</span><span class="o">)</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">‹{ xs::'a list. length xs =</span>
<span class="s">LENGTH('b) }›</span>
<span class="w">  </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="n">simp</span><span class="w"> </span><span class="n">add</span><span class="o">:</span><span class="w"> </span><span class="n">Ex_list_of_length</span><span class="o">)</span>
</code></pre></div>
<p>as a BNF?  Or alternatively, a way to massage the type declaration above<br>
into something that can be declared as a BNF?</p>
<p>From experimenting, it seems that the <code>lift_bnf</code> command with the type<br>
above appears to succeed (i.e., all subgoals generated by the command are<br>
closed by <code>auto</code>) but then the proof cannot be completed as a load of<br>
internal tactic errors are produced [1].  On the other hand, manually<br>
trying to declare the type above as a BNF using the <code>bnf</code> command fails as<br>
it appears to expect a relator function with a non-sensical type: after<br>
some debugging, something of the form ('c ⇒ 'd) ⇒ ('c ⇒ 'd).</p>
<p>(As a minor UI suggestion, the default error message produced by <code>bnf</code> for<br>
a bad relator, "Bad relator", could be improved by printing out the type<br>
that it expects.)</p>
<p>Thanks,<br>
Dominic</p>
<p>[1]: Errors produced:</p>
<p>Tactic failed<br>
The error(s) above occurred for the goal statement⌂:<br>
map_array id = id<br>
Tactic failed<br>
The error(s) above occurred for the goal statement⌂:<br>
⋀f g. map_array (g ∘ f) = map_array g ∘ map_array f<br>
Tactic failed<br>
The error(s) above occurred for the goal statement⌂:<br>
⋀f. set_array ∘ map_array f = (`) f ∘ set_array<br>
Tactic failed<br>
The error(s) above occurred for the goal statement⌂:<br>
⋀x f g. (⋀z. z ∈ set_array x ⟹ f z = g z) ⟹ map_array f x = map_array g x<br>
Tactic failed<br>
The error(s) above occurred for the goal statement⌂:<br>
⋀R. rel_array R =<br>
     (BNF_Def.Grp {x. set_array x ⊆ {(x, y). R x y}} (map_array fst))¯¯ OO<br>
BNF_Def.Grp {x. set_array x ⊆ {(x, y). R x y}} (map_array snd)<br>
exception TYPE_MATCH raised (line 438 of "type.ML")</p>



<a name="411243720"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Declaring%20a%20type%20of%20polymorphic%20fixed-length%20l.../near/411243720" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Declaring.20a.20type.20of.20polymorphic.20fixed-length.20l.2E.2E.2E.html#411243720">(Jan 04 2024 at 18:57)</a>:</h4>
<p>From: Dmitriy Traytel &lt;<a href="mailto:traytel@di.ku.dk">traytel@di.ku.dk</a>&gt;<br>
Hi Dominic,</p>
<p>The following works for me:</p>
<p>typedef (overloaded) ('a, 'b::‹{len}›) array = ‹{ xs::'a list. length xs = LENGTH('b) }›<br>
  by (simp add: Ex_list_of_length)</p>
<p>lift_bnf (no_warn_wits, no_warn_transfer) ('a, 'b :: len) array<br>
  by auto</p>
<p>The options just suppress the warnings. Perhaps you forgot the class annotation on ‘b?</p>
<p>The bnf command alternative also works, but involves of course a more complex proof where one needs to be careful with type annotation in the right places.</p>
<p>definition "map_array ≡ λf. Abs_array ∘ map f ∘ Rep_array"<br>
definition "set_array ≡ set ∘ Rep_array"<br>
definition "rel_array ≡ λR. BNF_Def.vimage2p Rep_array Rep_array (list_all2 R)"<br>
definition "pred_array ≡ λP. list_all P ∘ Rep_array"</p>
<p>bnf "('a, 'b :: len) array"<br>
  map: "map_array :: ('a ⇒ 'a') ⇒ ('a, 'b) array ⇒ ('a', 'b :: len) array"<br>
  sets: set_array<br>
  bd: natLeq<br>
  rel: "rel_array :: ('a ⇒ 'a' ⇒ bool) ⇒ ('a, 'b) array ⇒ ('a', 'b :: len) array ⇒ bool"<br>
  pred: pred_array<br>
proof<br>
  fix R :: "'a ⇒ 'b ⇒ bool"<br>
  show "(rel_array R ::  ('a, 'd) array ⇒  ('b, 'd) array ⇒ bool) =<br>
    (λx y. ∃z :: ('a × 'b, 'd :: len) array. set_array z ⊆ {(x, y). R x y} ∧ map_array fst z = x ∧ map_array snd z = y)"<br>
    unfolding rel_array_def vimage2p_def fun_eq_iff<br>
  proof (safe dest!: list.in_rel[THEN iffD1])<br>
    fix x :: "('a, 'd :: len) array" and y :: "('b, 'd :: len) array" and z<br>
    assume "set z ⊆ {(x, y). R x y}" and map: "map fst z = Rep_array x" "map snd z = Rep_array y"<br>
    from this(1) this(2,3)[symmetric] show "∃z :: ('a × 'b, 'd :: len) array. set_array z ⊆ {(x, y). R x y} ∧<br>
           map_array fst z = x ∧ map_array snd z = y"<br>
      using Rep_array[of x] Rep_array[of y]<br>
      by (intro exI[where x = "Abs_array z"])<br>
        (auto simp: Rep_array[simplified] Abs_array_inverse Rep_array_inverse<br>
          map_array_def set_array_def subset_iff dest: sym)<br>
  qed (auto simp: map_array_def set_array_def<br>
    Rep_array[simplified] Abs_array_inverse list.rel_map list.rel_refl_strong subset_iff)<br>
qed (auto simp: fun_eq_iff map_array_def set_array_def rel_array_def pred_array_def<br>
    Rep_array[simplified] Abs_array_inject Abs_array_inverse Rep_array_inverse vimage2p_def<br>
    list.rel_compp list.pred_set finite_iff_ordLess_natLeq[symmetric]<br>
    natLeq_card_order natLeq_cinfinite regularCard_natLeq)</p>
<p>Best wishes,<br>
Dmitriy</p>



<a name="411255939"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Declaring%20a%20type%20of%20polymorphic%20fixed-length%20l.../near/411255939" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Declaring.20a.20type.20of.20polymorphic.20fixed-length.20l.2E.2E.2E.html#411255939">(Jan 04 2024 at 20:23)</a>:</h4>
<p>From: <a href="mailto:hannobecker@posteo.de">hannobecker@posteo.de</a><br>
Hi Dominic, Dmitriy,</p>
<p>Dmitriy's snippet works for me, too, but it fails when inserting <br>
<code>setup_lifting</code> in between the <code>typedef</code> and <code>lift_bnf</code>:</p>
<div class="codehilite" data-code-language="Isabelle"><pre><span></span><code><span class="kn">typedef</span><span class="w"> </span><span class="o">(</span><span class="kp">overloaded</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n n-Type">'a</span><span class="o">,</span><span class="w"> </span><span class="n n-Type">'b</span><span class="o">::</span><span class="s">‹{len}›</span><span class="o">)</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">‹{ xs::'a list. length xs</span>
<span class="s">= LENGTH('b) }›</span>
<span class="w">   </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="n">simp</span><span class="w"> </span><span class="n">add</span><span class="o">:</span><span class="w"> </span><span class="n">Ex_list_of_length</span><span class="o">)</span>

<span class="k">setup_lifting</span><span class="w"> </span><span class="n">array.type_definition_array</span>

<span class="n">lift_bnf</span><span class="w"> </span><span class="o">(</span><span class="n">no_warn_wits</span><span class="o">,</span><span class="w"> </span><span class="n">no_warn_transfer</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="n n-Type">'a</span><span class="o">,</span><span class="w"> </span><span class="n n-Type">'b</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">len</span><span class="o">)</span><span class="w"> </span><span class="n">array</span>
<span class="w">   </span><span class="k">by</span><span class="w"> </span><span class="n">auto</span>
</code></pre></div>
<p>This fails with:</p>
<div class="codehilite" data-code-language="Isabelle"><pre><span></span><code><span class="n">exception</span><span class="w"> </span><span class="n">UnequalLengths</span><span class="w"> </span><span class="n">raised</span><span class="w"> </span><span class="o">(</span><span class="n">line</span><span class="w"> </span><span class="n">554</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="s">"library.ML"</span><span class="o">)</span>
</code></pre></div>
<p>Any clue if/why <code>lift_bnf</code> has to happen before <code>setup_lifting</code>?</p>
<p>Hanno</p>



<a name="411354345"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Declaring%20a%20type%20of%20polymorphic%20fixed-length%20l.../near/411354345" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Declaring.20a.20type.20of.20polymorphic.20fixed-length.20l.2E.2E.2E.html#411354345">(Jan 05 2024 at 11:42)</a>:</h4>
<p>From: Dominic Mulligan &lt;<a href="mailto:cl-isabelle-users@lists.cam.ac.uk">cl-isabelle-users@lists.cam.ac.uk</a>&gt;<br>
Hi Dmitriy,</p>
<p>Thanks for that, we've got it working now.  As Hanno mentions, the<br>
<code>lift_bnf</code> command seems to behave strangely if <code>setup_lifting</code> is called<br>
first which was causing some confusion.</p>
<p>Thanks,<br>
Dominic</p>



<a name="419345252"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Declaring%20a%20type%20of%20polymorphic%20fixed-length%20l.../near/419345252" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Declaring.20a.20type.20of.20polymorphic.20fixed-length.20l.2E.2E.2E.html#419345252">(Feb 01 2024 at 22:33)</a>:</h4>
<p>From: Dmitriy Traytel &lt;<a href="mailto:traytel@di.ku.dk">traytel@di.ku.dk</a>&gt;<br>
Hi Hanno,</p>
<p>Thanks for pointing that out. I only managed to finalize and push my patch (see below) now.</p>
<p>Indeed lift_bnf attempts to do a bit more in the presence of setup_lifting (namely, to derive transfer rules for the lifted set, map, etc.). This derivation did not work in cases where the raw type (‘a list in your example) had fewer type variables than the abstract type ((‘a, ‘b :: len) array).</p>
<p>I made the derivation a bit more robust in Isabelle’s development repository (isabelle/33b10cd883ae) and your example will work in the next Isabelle release. In the meantime, one could use a singleton type as a workaround: </p>
<p>typedef (overloaded) ('a, 'b::‹{len}›) array = ‹{ (xs::'a list, _::'b itself). length xs = LENGTH('b) }›<br>
 by (simp add: Ex_list_of_length)</p>
<p>setup_lifting array.type_definition_array</p>
<p>lift_bnf (no_warn_wits, no_warn_transfer) ('a, 'b :: len) array<br>
  by auto</p>
<p>Best wishes,<br>
Dmitriy</p>



<a name="419390378"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Declaring%20a%20type%20of%20polymorphic%20fixed-length%20l.../near/419390378" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Declaring.20a.20type.20of.20polymorphic.20fixed-length.20l.2E.2E.2E.html#419390378">(Feb 02 2024 at 06:13)</a>:</h4>
<p>From: <a href="mailto:hannobecker@posteo.de">hannobecker@posteo.de</a><br>
Hi Dmitriy,</p>
<p>This is great, thank you both for the workaround and for preparing a <br>
patch for '24.</p>
<p>Best,<br>
Hanno</p>



<hr><p>Last updated: Nov 01 2025 at 16:22 UTC</p>
</html>