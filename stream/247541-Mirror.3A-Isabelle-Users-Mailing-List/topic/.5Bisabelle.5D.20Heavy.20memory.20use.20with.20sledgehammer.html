<html>
<head><meta charset="utf-8"><title>[isabelle] Heavy memory use with sledgehammer · Mirror: Isabelle Users Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/index.html">Mirror: Isabelle Users Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html">[isabelle] Heavy memory use with sledgehammer</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="352810658"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/352810658" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#352810658">(Apr 26 2023 at 14:03)</a>:</h4>
<p>From: Ghilain Bergeron &lt;<a href="mailto:ghilain.bergeron@inria.fr">ghilain.bergeron@inria.fr</a>&gt;<br>
Hello. </p>
<p>I am having a bit of a problem with sledgehammer. <br>
It seems that sometimes, the memory it used isn't being reclaimed (through GC, I guess). <br>
This leads me to having very high memory usage (e.g. a polyml process with 16GB of RAM used) and the <br>
longer it happens for, the more likely it is that sledgehammer is going to crash the LSP server <br>
(note: it also happens within the JEdit interface). <br>
Does anyone have any idea how to try and debug this? Or is this expected behavior when running <br>
sledgehammer often? </p>
<p>Thanks in advance, <br>
Ghilain.</p>



<a name="352813660"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/352813660" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#352813660">(Apr 26 2023 at 14:12)</a>:</h4>
<p>From: Dominic Mulligan &lt;<a href="mailto:cl-isabelle-users@lists.cam.ac.uk">cl-isabelle-users@lists.cam.ac.uk</a>&gt;<br>
Hi,</p>
<p>To add another observation: I, along with multiple colleagues, have also<br>
noticed a similar and perhaps related effect with Isabelle2022 on Apple M1<br>
Macs.  After prolonged use Isabelle performance seems to significantly<br>
degrade, including that of Sledgehammer, to the point where it struggles to<br>
find proofs for anything and even invoking the external provers seems to<br>
take an age.  Killing Isabelle and restarting seems to fix the problem.</p>
<p>Thanks,<br>
Dominic</p>



<a name="352815984"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/352815984" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#352815984">(Apr 26 2023 at 14:20)</a>:</h4>
<p>From: Jasmin Blanchette &lt;<a href="mailto:jasmin.blanchette@ifi.lmu.de">jasmin.blanchette@ifi.lmu.de</a>&gt;<br>
Dear Ghilain,</p>
<p>This is definitely not the intended behavior. I suspect the issue might be related to your platform. Are you using Windows? Also, do you know which prover(s) this happens with, e.g. by investigating the list of running processes?</p>
<p>In principle, provers are invoked with a soft and a hard timeout, so they should terminate, but there has been reports before of provers keeping on running.</p>
<p>Best,<br>
Jasmin</p>



<a name="352818565"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/352818565" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#352818565">(Apr 26 2023 at 14:28)</a>:</h4>
<p>From: Ghilain Bergeron &lt;<a href="mailto:ghilain.bergeron@inria.fr">ghilain.bergeron@inria.fr</a>&gt;<br>
Hi Jasmin! </p>
<p>I am using NixOS version 22.11, with Isabelle2022. There does not seem to be any prover left running <br>
when sledgehammer finishes, according to my system monitor. <br>
However, all I can see is a "poly" process slowly filling up my RAM each time I call sledgehammer, although <br>
from time to time there seems to be a GC run (not frequently at all; currently the process takes 13.5GB of my RAM <br>
and I ran sledgehammer like 5 times on a fairly complex goal). <br>
From what I can see, here's the list of provers running on my machine: z3, cvc4, SPASS, veriT, vampire, <br>
eprover-ho and zipperposition. </p>
<p>I also have noticed the same issue that Dominic Mulligan is reporting (in a follow-up mail), regarding degrading performance <br>
due to prolonged Isabelle use. Not sure if this is relevant to this problem though. </p>
<p>Regards, <br>
Ghilain</p>



<a name="352850920"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/352850920" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#352850920">(Apr 26 2023 at 15:38)</a>:</h4>
<p>From: "Eugene W. Stark" &lt;<a href="mailto:isabelle-users@starkeffect.com">isabelle-users@starkeffect.com</a>&gt;<br>
To add to this: it is my experience and belief that, under certain modes of use, Sledgehammer causes<br>
Poly/ML to leak heap space, resulting in the heap utilization eventually bumping up against the limit<br>
and causing frequent garbage collection and poor performance.  At that point, restarting Isabelle is<br>
necessary to restore performance.</p>
<p>This occurs for me on Linux (Ubuntu 22.04).  It might be related to the long-standing issue with some<br>
of the external provers not handling signals correctly and popping up notifications that the external<br>
program has crashed.</p>
<p>- Gene Stark</p>



<a name="353126392"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353126392" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353126392">(Apr 27 2023 at 07:09)</a>:</h4>
<p>From: Jasmin Blanchette &lt;<a href="mailto:jasmin.blanchette@ifi.lmu.de">jasmin.blanchette@ifi.lmu.de</a>&gt;<br>
I suspect the issues are related to the Poly/ML platform or to the Isabelle/ML infrastructure. Perhaps Makarius can comment on this thread?</p>
<p>Best,<br>
Jasmin</p>



<a name="353188314"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353188314" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353188314">(Apr 27 2023 at 09:29)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
We need something reproducible to work with.</p>
<ul>
<li>
<p>Specifications of the hardware and OS version.</p>
</li>
<li>
<p>Examples that are publicly available somewhere.</p>
</li>
</ul>
<p>Generally note that ARM64 is still not fully supported: On macOS Intel <br>
binaries work out of the box, but I don't know if and how the implicit <br>
translation via Rosetta 2 can interfere with run times and interruptibility.</p>
<p>Makarius</p>



<a name="353189689"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353189689" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353189689">(Apr 27 2023 at 09:32)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On 26/04/2023 16:28, Ghilain Bergeron wrote:</p>
<blockquote>
<p>I am using NixOS version 22.11, with Isabelle2022. There does not seem to be <br>
any prover left running<br>
when sledgehammer finishes, according to my system monitor.</p>
</blockquote>
<p>NixOS is not on the list of officially supported Isabelle platforms, see also <br>
<a href="https://isabelle.in.tum.de/installation.html">https://isabelle.in.tum.de/installation.html</a></p>
<p>So it must be a package provided privately by someone else (Who should also <br>
take responsiblitity for it).</p>
<p>Can you provide a source for that? I would be interested so see how it was <br>
done, to say if there is a chance of it working properly.</p>
<blockquote>
<p>However, all I can see is a "poly" process slowly filling up my RAM each time <br>
I call sledgehammer, although<br>
from time to time there seems to be a GC run (not frequently at all; currently <br>
the process takes 13.5GB of my RAM<br>
and I ran sledgehammer like 5 times on a fairly complex goal).</p>
</blockquote>
<p>Going towards 16 GB is always critical, because ML GC times are getting long <br>
and can interfere with the interaction. 16 GB is a hard limit of the default <br>
Poly/ML platform.</p>
<p>It might be better to set ML_system_64 = "true" in <br>
$ISABELLE_HOME_USER/etc/preferences (while the PIDE is not running) and try <br>
with a machine that has 64 GB, or so.</p>
<p>Anyway, are these proof problems somewhere publicly available, e.g. on <br>
Isabelle/AFP?</p>
<p>Makarius</p>



<a name="353193392"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353193392" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353193392">(Apr 27 2023 at 09:41)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On 26/04/2023 17:30, Eugene W. Stark wrote:</p>
<blockquote>
<p>To add to this: it is my experience and belief that, under certain modes of <br>
use, Sledgehammer causes<br>
Poly/ML to leak heap space, resulting in the heap utilization eventually <br>
bumping up against the limit<br>
and causing frequent garbage collection and poor performance.  At that point, <br>
restarting Isabelle is<br>
necessary to restore performance.</p>
</blockquote>
<p>As you have plenty of public examples on Isabelle/AFP, can you find a <br>
situation where it is somehow reproducible?</p>
<p>We also need a specification of the hardware resources (RAM, CPU cores).</p>
<blockquote>
<p>It might be related to the <br>
long-standing issue with some<br>
of the external provers not handling signals correctly and popping up <br>
notifications that the external<br>
program has crashed.</p>
</blockquote>
<p>What exactly is the signal / return code of the crash?</p>
<p>Maybe this is just an out-of-memory situation in Linux.</p>
<p>Makarius</p>



<a name="353194601"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353194601" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353194601">(Apr 27 2023 at 09:44)</a>:</h4>
<p>From: Ghilain Bergeron &lt;<a href="mailto:ghilain.bergeron@inria.fr">ghilain.bergeron@inria.fr</a>&gt;<br>
The original package for Isabelle2021 is on nixpkgs: [ <a href="https://github.com/NixOS/nixpkgs/blob/nixos-22.11/pkgs/applications/science/logic/isabelle/default.nix">https://github.com/NixOS/nixpkgs/blob/nixos-22.11/pkgs/applications/science/logic/isabelle/default.nix</a> | <a href="https://github.com/NixOS/nixpkgs/blob/nixos-22.11/pkgs/applications/science/logic/isabelle/default.nix">https://github.com/NixOS/nixpkgs/blob/nixos-22.11/pkgs/applications/science/logic/isabelle/default.nix</a> ] <br>
However, I have modified it a bit for Isabelle2022: [ <a href="https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/isabelle.nix">https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/isabelle.nix</a> | <a href="https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/isabelle.nix">https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/isabelle.nix</a> ] <br>
Note that I am not using Poly/ML from nixpkgs either: [ <a href="https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/polyml.nix">https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/polyml.nix</a> | <a href="https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/polyml.nix">https://github.com/Mesabloo/nix-config/blob/master/extra/nix-overlays/packages/polyml.nix</a> ] as it doesn't have the option "--enable-intinf-as-int", which makes it so that Isabelle cannot be built. Perhaps I am missing some other configuration flag? </p>
<p>My "custom" Nix script for Isabelle uses the Isabelle installation in [ <a href="https://github.com/m-fleury/isabelle-emacs">https://github.com/m-fleury/isabelle-emacs</a> | <a href="https://github.com/m-fleury/isabelle-emacs">https://github.com/m-fleury/isabelle-emacs</a> ] although this should change close to nothing regarding Isabelle itself, as it mainly is a mirror + some modifications to the LSP server + a LSP mode for emacs. </p>
<blockquote>
<p>It might be better to set ML_system_64 = "true" in <br>
$ISABELLE_HOME_USER/etc/preferences (while the PIDE is not running) and try <br>
with a machine that has 64 GB, or so. </p>
</blockquote>
<p>Unfortunately, I don't have access to such a machine, only 32 GB of RAM. </p>
<blockquote>
<p>Anyway, are these proof problems somewhere publicly available, e.g. on <br>
Isabelle/AFP? </p>
</blockquote>
<p>Currently they aren't, and I don't know how long they won't be. However, it shouldn't matter much, as long as the project is not very small, and the proofs are not easy to find for sledgehammer. </p>
<p>Cheers, <br>
Ghilain. </p>
<p>De: "Makarius" &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt; <br>
À: "Ghilain Bergeron" &lt;<a href="mailto:ghilain.bergeron@inria.fr">ghilain.bergeron@inria.fr</a>&gt;, "Jasmin Blanchette" &lt;<a href="mailto:jasmin.blanchette@ifi.lmu.de">jasmin.blanchette@ifi.lmu.de</a>&gt; <br>
Cc: "cl-isabelle-users" &lt;<a href="mailto:cl-isabelle-users@lists.cam.ac.uk">cl-isabelle-users@lists.cam.ac.uk</a>&gt; <br>
Envoyé: Jeudi 27 Avril 2023 11:25:54 <br>
Objet: Re: [isabelle] Heavy memory use with sledgehammer </p>
<p>BQ_BEGIN<br>
On 26/04/2023 16:28, Ghilain Bergeron wrote: </p>
<p>BQ_BEGIN</p>
<p>I am using NixOS version 22.11, with Isabelle2022. There does not seem to be <br>
any prover left running <br>
when sledgehammer finishes, according to my system monitor. <br>
BQ_END</p>
<p>NixOS is not on the list of officially supported Isabelle platforms, see also <br>
<a href="https://isabelle.in.tum.de/installation.html">https://isabelle.in.tum.de/installation.html</a> </p>
<p>So it must be a package provided privately by someone else (Who should also <br>
take responsiblitity for it). </p>
<p>Can you provide a source for that? I would be interested so see how it was <br>
done, to say if there is a chance of it working properly. </p>
<p>BQ_BEGIN<br>
However, all I can see is a "poly" process slowly filling up my RAM each time <br>
I call sledgehammer, although <br>
from time to time there seems to be a GC run (not frequently at all; currently <br>
the process takes 13.5GB of my RAM <br>
and I ran sledgehammer like 5 times on a fairly complex goal). <br>
BQ_END</p>
<p>Going towards 16 GB is always critical, because ML GC times are getting long <br>
and can interfere with the interaction. 16 GB is a hard limit of the default <br>
Poly/ML platform. </p>
<p>It might be better to set ML_system_64 = "true" in <br>
$ISABELLE_HOME_USER/etc/preferences (while the PIDE is not running) and try <br>
with a machine that has 64 GB, or so. </p>
<p>Anyway, are these proof problems somewhere publicly available, e.g. on <br>
Isabelle/AFP? </p>
<p>Makarius <br>
BQ_END</p>



<a name="353197340"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353197340" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353197340">(Apr 27 2023 at 09:50)</a>:</h4>
<p>From: Jan van Brügge &lt;<a href="mailto:jan@vanbruegge.de">jan@vanbruegge.de</a>&gt;</p>
<blockquote>
<p>Can you provide a source for that? I would be interested so see how it was done, to say if there is a chance of it working properly.</p>
</blockquote>
<p>I am packaging Isabelle for NixOS. The packaging instructions are here: <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/logic/isabelle/default.nix#L88">https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/science/logic/isabelle/default.nix#L88</a></p>
<p>To summarize: I take the official Isabelle release, replace the bundled polyml with a version built by nix (but based off the same commit as the Isabelle release), and patch the bundled ATPs so they can find libc and other dependencies.</p>
<p>Apr 27, 2023 10:32:23 AM Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;:</p>
<blockquote>
<p>On 26/04/2023 16:28, Ghilain Bergeron wrote:</p>
<blockquote>
<p>I am using NixOS version 22.11, with Isabelle2022. There does not seem to be any prover left running<br>
when sledgehammer finishes, according to my system monitor.</p>
</blockquote>
<p>NixOS is not on the list of officially supported Isabelle platforms, see also <a href="https://isabelle.in.tum.de/installation.html">https://isabelle.in.tum.de/installation.html</a></p>
<p>So it must be a package provided privately by someone else (Who should also take responsiblitity for it).</p>
<p>Can you provide a source for that? I would be interested so see how it was done, to say if there is a chance of it working properly.</p>
<blockquote>
<p>However, all I can see is a "poly" process slowly filling up my RAM each time I call sledgehammer, although<br>
from time to time there seems to be a GC run (not frequently at all; currently the process takes 13.5GB of my RAM<br>
and I ran sledgehammer like 5 times on a fairly complex goal).</p>
</blockquote>
<p>Going towards 16 GB is always critical, because ML GC times are getting long and can interfere with the interaction. 16 GB is a hard limit of the default Poly/ML platform.</p>
<p>It might be better to set ML_system_64 = "true" in $ISABELLE_HOME_USER/etc/preferences (while the PIDE is not running) and try with a machine that has 64 GB, or so.</p>
<p>Anyway, are these proof problems somewhere publicly available, e.g. on Isabelle/AFP?</p>
<p>Makarius</p>
</blockquote>



<a name="353207109"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353207109" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353207109">(Apr 27 2023 at 10:12)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
External processes are actually managed in Isabelle/Scala: Isabelle/ML makes <br>
an explicit protocol invocation it for that, e.g. see <br>
<a href="https://isabelle.sketis.net/repos/isabelle-release/file/tip/src/Pure/System/isabelle_system.ML">https://isabelle.sketis.net/repos/isabelle-release/file/tip/src/Pure/System/isabelle_system.ML</a></p>
<p>This already supports a timeout parameter, but historically most Isabelle/ML <br>
applications (including Sledgehammer) use Timeout.apply on the ML side: which <br>
is also subject to GC times.</p>
<p>For heavy computations within Isabelle/ML it is often better to use <br>
Timeout.apply_physical, e.g. the change <br>
<a href="https://isabelle.sketis.net/repos/isabelle-release/rev/d54b3c96ee50">https://isabelle.sketis.net/repos/isabelle-release/rev/d54b3c96ee50</a> --- but <br>
this is probably not relevant for Sledgehammer.</p>
<p>Below is a minimal example to show the difference of ML vs. Scala timeouts, <br>
even including a protocol trace. For the latter, you need to edit <br>
$ISABELLE_HOME_USER/etc/preferences <em>before</em> starting the Prover IDE as follows:</p>
<p>bash_process_debugging = "true"</p>
<p>Then you start "isabelle jedit" on the terminal and process the subsequent ML <br>
snippets in some theory context as usual:</p>
<p>ML ‹val script = "sleep 10"; val timeout = seconds 2.0;›</p>
<p>text ‹timeout managed in Isabelle/ML:›<br>
ML ‹Timeout.apply timeout Isabelle_System.bash_process (Bash.script script)›</p>
<p>text ‹timeout managed in Isabelle/Scala:›<br>
ML ‹Isabelle_System.bash_process (Bash.script script |&gt; Bash.timeout timeout)›</p>
<p>(*<br>
11:55:34 AM [Isabelle.client] [error] client: start "bash_process" <br>
(uuid=66aac7fa-2db8-411a-8fd2-7b2bcefe1e6b, timeout=0.0)<br>
11:55:36 AM [Isabelle.client] [error] client: kill <br>
66aac7fa-2db8-411a-8fd2-7b2bcefe1e6b<br>
11:55:36 AM [Isabelle.client] [error] client: start "bash_process" <br>
(uuid=fdcf8608-ca94-46b4-9a6c-3d1416ed2755, timeout=2.0)<br>
11:55:36 AM [Isabelle.bash_process] [error] bash_process: stop "bash_process" <br>
(uuid=66aac7fa-2db8-411a-8fd2-7b2bcefe1e6b, return_code=130)<br>
11:55:38 AM [Isabelle.bash_process] [error] bash_process: stop "bash_process" <br>
(uuid=fdcf8608-ca94-46b4-9a6c-3d1416ed2755, return_code=142)<br>
11:55:38 AM [Isabelle.client] [error] client: kill <br>
fdcf8608-ca94-46b4-9a6c-3d1416ed2755<br>
*)</p>
<p>Return code 130 is SIGINT, originating from the Isabelle/ML implementation of <br>
Timeout.apply.</p>
<p>Return code 142 is SIGALRM, originating from Isabelle/Scala --- not the <br>
external process. See also <br>
<a href="https://isabelle.sketis.net/repos/isabelle-release/file/tip/src/Pure/System/bash.scala#l322">https://isabelle.sketis.net/repos/isabelle-release/file/tip/src/Pure/System/bash.scala#l322</a></p>
<p>Sledgehammer might benefit from moving the timeout from ML into Scala, because <br>
that is closer to the actual process and the "watchdog" is not subject to the <br>
health of the ML runtime system.</p>
<p>It is also interesting to run Sledgehammer examples with the above system <br>
options bash_process_debugging = "true" to see rather mixed return codes.</p>
<p>(One day, Isabelle/PIDE will include a GUI panel for bash processes, but not now.)</p>
<p>Makarius</p>



<a name="353210854"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353210854" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353210854">(Apr 27 2023 at 10:22)</a>:</h4>
<p>From: "Eugene W. Stark" &lt;<a href="mailto:isabelle-users@starkeffect.com">isabelle-users@starkeffect.com</a>&gt;<br>
[Resend to list only, because my previous send had a From address other than the subscribed one.]</p>
<p>On 4/27/23 05:31, Makarius wrote:</p>
<blockquote>
<p>On 26/04/2023 17:30, Eugene W. Stark wrote:</p>
<blockquote>
<p>To add to this: it is my experience and belief that, under certain modes of use, Sledgehammer causes<br>
Poly/ML to leak heap space, resulting in the heap utilization eventually bumping up against the limit<br>
and causing frequent garbage collection and poor performance.  At that point, restarting Isabelle is<br>
necessary to restore performance.</p>
</blockquote>
<p>As you have plenty of public examples on Isabelle/AFP, can you find a situation where it is somehow reproducible?</p>
<p>We also need a specification of the hardware resources (RAM, CPU cores).</p>
</blockquote>
<p>I currently experience this on the following platform:</p>
<p>Intel i9-10850K (10 cores)<br>
    128GB RAM<br>
        JEDIT_JAVA_OPTIONS="-Xmx16384m"<br>
        ML_OPTIONS="--maxheap 64G"<br>
    Ubuntu 22.04:<br>
        Linux 5.19.0-40-generic #41~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Mar 31 16:00:14 UTC 2 x86_64 x86_64 x86_64 GNU/Linux</p>
<p>There isn't a cookbook recipe for reproducing this.  The problem typically occurs after a long session<br>
with heavy use of "try" and/or the Sledgehammer panel.</p>
<p>To my mind, the problem is consistent with some kind of situation where weak references or the like<br>
are created into the ML heap as a result of running the external provers, and then these references are<br>
sometimes lost, resulting in a leak over time.  However, I have no specific knowledge of how the<br>
external provers are interfaced with ML.  If there in fact are some kind of weak references of this<br>
nature, I would think that instrumenting their creation and reclamation could potentially<br>
indicate if there are leaks involving them.</p>
<blockquote>
<blockquote>
<p>It might be related to the long-standing issue with some<br>
of the external provers not handling signals correctly and popping up notifications that the external<br>
program has crashed.</p>
</blockquote>
<p>What exactly is the signal / return code of the crash?</p>
<p>Maybe this is just an out-of-memory situation in Linux.</p>
</blockquote>
<p>No, it is not an out-of-memory situation.  We have discussed this issue in this forum some years ago.<br>
I did some investigation at that time and found that some of the provers under certain situations do<br>
not properly handle signals sent to them to cause them to terminate, resulting in the OS kernel flagging<br>
an abnormal termination.  Under Ubuntu, at least, this causes a pop-up notification<br>
("A system program has failed", or the like).   Frequently after an extended session using Sledgehammer<br>
I have to clear several (sometimes many) of these notifications, which accumulate underneath the<br>
application windows. In at least one case, I did trace the origin of the problem to a signal handler<br>
that was either part of the external prover code or part of some "glue" code that interfaced the Isabelle<br>
system to that external prover -- I don't remember which.  I think the signal involved might have been<br>
SIGABRT, but again I don't recall for sure at this time.  It was a signal whose default disposition<br>
is to cause a core dump, because otherwise a notification would not be generated by the OS.</p>
<p>If I recall correctly, the result of the previous thread and my own investigation was that<br>
"It is the fault of the external prover implementers" and that my problem report should be directed at<br>
them.  Getting involved in that was not consistent with my own goals in using the system, so I did not<br>
pursue it further at that time, but the problem still exists.  The reason I mentioned this again in<br>
the current thread is that I speculate that the abnormal termination of an external prover in this way<br>
could be the origin of leaked storage in the ML heap.</p>
<p>- Gene Stark</p>



<a name="353212902"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353212902" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353212902">(Apr 27 2023 at 10:26)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
Note that "Isabelle itself" is everything that we bundle in the official <br>
release. This also includes OpenJDK and Scala, now even VSCode/Electron/Node.js.</p>
<p>There are reasons for that: over the decades, strange problems have occurred <br>
with arbitrary versions of such system components seen in the wild.</p>
<p>So a proper version of the NixOS package would take everything from the <br>
official Isabelle download, without any censorship.</p>
<p>Isabelle actually shares the approach of NixOS to include just one specific <br>
version of (almost) everything.</p>
<p>Makarius</p>



<a name="353215861"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353215861" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353215861">(Apr 27 2023 at 10:33)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
That is an interesting high-end configuration.</p>
<p>From a distance, I would say that ML GC times become so long that the overall <br>
model of Sledgehammer timeout no longer fits.</p>
<p>It could be resolved by moving timeouts from ML to Scala, as I have sketched <br>
earlier.</p>
<p>Makarius</p>



<a name="353216779"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353216779" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353216779">(Apr 27 2023 at 10:35)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
This is very complex. I am not going to study nor to review it.</p>
<p>It is your responsible to sort out problems stemming from the disassembly of <br>
all Isabelle components and reassembly in a slightly different manner.</p>
<p>Makarius</p>



<a name="353219585"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353219585" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353219585">(Apr 27 2023 at 10:42)</a>:</h4>
<p>From: Dominique Unruh &lt;<a href="mailto:cl-isabelle-users@lists.cam.ac.uk">cl-isabelle-users@lists.cam.ac.uk</a>&gt;<br>
Hi,</p>
<p>I also have experienced over the years (i.e., in multiple versions) that <br>
there Isabelle tends to slow down a lot after heavy use (involving lots <br>
of sledgehammers, interrupted and restarted sledgehammers due to edits <br>
further up in the code, rerunning proofs (again, because of editing <br>
fragments higher than the bottom of the visible part of the document).</p>
<p>The problem is that this is not something that can be easily reproduced. <br>
The theory file we have at that point is not to blame (restarting <br>
Isabelle fixes the problem on the same file). It is more the interaction <br>
that somehow leads to a problem.</p>
<p>I have the following observations:</p>
<p>* It's not jEdit that's stuck (because unloading the plugin and<br>
    reloading it tends to resolve the problem).</p>
<p>* There seems to be frequent GC once Isabelle is in this state.<br>
  * It does not seem to be due to the load of the running sledghammers<br>
    itself (because sometimes I have waited a long time to give it a<br>
    chance to finish with whatever it is doing, to no avail).</p>
<p>* Sometimes, it's not just a slowdown but Isabelle completely stops<br>
    doing anything (one can edit, but colors/output tab are not<br>
    updated). However, I don't know if it's the same issue.</p>
<p>Since it is almost impossible to produce something reproducible here <br>
except something like "work for a few hours and intensively edit and run <br>
sledgehammer or try after every goal", I think what we need is the <br>
following:</p>
<p>Is there some way to produce some post-mortem analysis? I.e., next time <br>
I observe this, would there be something I can do to get a core-dump or <br>
thread-dump or whatever that would be helpful (for Makarius, I assume) <br>
to diagnose what is happening or at least what further inquiries need to <br>
be made?</p>
<p>Best wishes,<br>
Dominique.</p>



<a name="353225457"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353225457" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353225457">(Apr 27 2023 at 10:55)</a>:</h4>
<p>From: "Eugene W. Stark" &lt;<a href="mailto:isabelle-users@starkeffect.com">isabelle-users@starkeffect.com</a>&gt;<br>
The quoted message mentions some things that I have observed that I consider to be (potentially)<br>
separate issues from the main one that this thread has been addressing.  These are:</p>
<p>(1)  An instability that occurs in which Isabelle queues up tens or hundreds of thousands<br>
        of "Future Tasks" (as indicated by the monitor panel), which do not get cancelled<br>
        even after the "Cancel" button on the Sledgehammer panel has been pressed or the<br>
        "try" has been deleted from the JEdit editing buffer.  This situation can take<br>
        many minutes (or longer) to resolve itself.  This behavior is also long-standing,<br>
        though it does not occur as frequently as it did a few years ago (from my point of<br>
        view).</p>
<p>(2)  Extreme time taken by Poly/ML for an apparent major GC.  "ML Cleanup" shows in the<br>
        JEdit window and although JEdit remains responsive, nothing gets updated that<br>
        requires output from ML.  This situation can persist for many minutes or longer.<br>
        Sometimes I have gone away for perhaps an hour and come back to find it still<br>
        in that state, whereupon I give up and just restart Isabelle.</p>
<p>It is possible, I suppose that this is "expected" behavior; however, in some<br>
        cases it has more the appearance of a deadlock situation.</p>
<p>- Gene Stark</p>



<a name="353226410"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353226410" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353226410">(Apr 27 2023 at 10:57)</a>:</h4>
<p>From: "Eugene W. Stark" &lt;<a href="mailto:isabelle-users@starkeffect.com">isabelle-users@starkeffect.com</a>&gt;<br>
[CC to original recipients]</p>
<p>The quoted message mentions some things that I have observed that I consider to be (potentially)<br>
separate issues from the main one that this thread has been addressing.  These are:</p>
<p>(1)  An instability that occurs in which Isabelle queues up tens or hundreds of thousands<br>
        of "Future Tasks" (as indicated by the monitor panel), which do not get cancelled<br>
        even after the "Cancel" button on the Sledgehammer panel has been pressed or the<br>
        "try" has been deleted from the JEdit editing buffer.  This situationcan take<br>
        many minutes (or longer) to resolve itself.  This behavior is also long-standing,<br>
        though it does not occur as frequently as it did a few years ago (from my point of<br>
        view).</p>
<p>(2)  Extreme time taken by Poly/ML for an apparent major GC.  "ML Cleanup" shows in the<br>
        JEdit window and although JEdit remains responsive, nothing gets updated that<br>
        requires output from ML.  This situation can persist for many minutesor longer.<br>
        Sometimes I have gone away for perhaps an hour and come back to find it still<br>
        in that state, whereupon I give up and just restart Isabelle.</p>
<p>It is possible, I suppose that this is "expected" behavior; however, in some<br>
        cases it has more the appearance of a deadlock situation.</p>
<p>- Gene Stark</p>



<a name="353265038"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353265038" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353265038">(Apr 27 2023 at 12:25)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
I would say it is better to do live monitoring with more details: ML tasks, ML <br>
threads, bash processes shown in the Prover IDE as some kind of "task manager".</p>
<p>Overall this is not a single program, but a parallel system consisting of many <br>
different components.</p>
<p>Makarius</p>



<a name="353265981"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353265981" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353265981">(Apr 27 2023 at 12:27)</a>:</h4>
<p>From: Dominique Unruh &lt;<a href="mailto:cl-isabelle-users@lists.cam.ac.uk">cl-isabelle-users@lists.cam.ac.uk</a>&gt;<br>
Hi,<br>
Of course. But I cannot interpret those things myself, so the question <br>
is: what of these would I send to the mailing list in case of a partly <br>
stuck Isabelle?</p>
<p>Best wishes,<br>
Dominique.</p>



<a name="353284701"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/353284701" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#353284701">(Apr 27 2023 at 13:07)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
A text snapshot of such a live monitor state.</p>
<p>Makarius</p>



<a name="354650050"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/354650050" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#354650050">(Apr 30 2023 at 10:13)</a>:</h4>
<p>From: Lex Bailey &lt;<a href="mailto:cl-isabelle-users@lists.cam.ac.uk">cl-isabelle-users@lists.cam.ac.uk</a>&gt;<br>
I have experienced the same on an M1 Mac, additionally I have found that<br>
other applications are affected.<br>
Music stutters when using sledgehammer, and eventually the MacOS OOM killer<br>
takes action (although it normally kills other programs before Isabelle,<br>
curiously)</p>



<a name="354650052"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/354650052" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#354650052">(Apr 30 2023 at 10:13)</a>:</h4>
<p>From: "Eugene W. Stark" &lt;<a href="mailto:stark@cs.stonybrook.edu">stark@cs.stonybrook.edu</a>&gt;<br>
On 4/27/23 05:31, Makarius wrote:</p>
<blockquote>
<p>On 26/04/2023 17:30, Eugene W. Stark wrote:</p>
<blockquote>
<p>To add to this: it is my experience and belief that, under certain modes of use, Sledgehammer causes<br>
Poly/ML to leak heap space, resulting in the heap utilization eventually bumping up against the limit<br>
and causing frequent garbage collection and poor performance.  At that point, restarting Isabelle is<br>
necessary to restore performance.</p>
</blockquote>
<p>As you have plenty of public examples on Isabelle/AFP, can you find a situation where it is somehow reproducible?</p>
<p>We also need a specification of the hardware resources (RAM, CPU cores).</p>
</blockquote>
<p>I currently experience this on the following platform:</p>
<p>Intel i9-10850K (10 cores)<br>
    128GB RAM<br>
        JEDIT_JAVA_OPTIONS="-Xmx16384m"<br>
        ML_OPTIONS="--maxheap 64G"<br>
    Ubuntu 22.04:<br>
        Linux 5.19.0-40-generic #41~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Mar 31 16:00:14 UTC 2 x86_64 x86_64 x86_64 GNU/Linux</p>
<p>There isn't a cookbook recipe for reproducing this.  The problem typically occurs after a long session<br>
with heavy use of "try" and/or the Sledgehammer panel.</p>
<p>To my mind, the problem is consistent with some kind of situation where weak references or the like<br>
are created into the ML heap as a result of running the external provers, and then these references are<br>
sometimes lost, resulting in a leak over time.  However, I have no specific knowledge of how the<br>
external provers are interfaced with ML.  If there in fact are some kind of weak references of this<br>
nature, I would think that instrumenting their creation and reclamation could potentially<br>
indicate if there are leaks involving them.</p>
<blockquote>
<blockquote>
<p>It might be related to the long-standing issue with some<br>
of the external provers not handling signals correctly and popping up notifications that the external<br>
program has crashed.</p>
</blockquote>
<p>What exactly is the signal / return code of the crash?</p>
<p>Maybe this is just an out-of-memory situation in Linux.</p>
</blockquote>
<p>No, it is not an out-of-memory situation.  We have discussed this issue in this forum some years ago.<br>
I did some investigation at that time and found that some of the provers under certain situations do<br>
not properly handle signals sent to them to cause them to terminate, resulting in the OS kernel flagging<br>
an abnormal termination.  Under Ubuntu, at least, this causes a pop-up notification<br>
("A system program has failed", or the like).   Frequently after an extended session using Sledgehammer<br>
I have to clear several (sometimes many) of these notifications, which accumulate underneath the<br>
application windows. In at least one case, I did trace the origin of the problem to a signal handler<br>
that was either part of the external prover code or part of some "glue" code that interfaced the Isabelle<br>
system to that external prover -- I don't remember which.  I think the signal involved might have been<br>
SIGABRT, but again I don't recall for sure at this time.  It was a signal whose default disposition<br>
is to cause a core dump, because otherwise a notification would not be generated by the OS.</p>
<p>If I recall correctly, the result of the previous thread and my own investigation was that<br>
"It is the fault of the external prover implementers" and that my problem report should be directed at<br>
them.  Getting involved in that was not consistent with my own goals in using the system, so I did not<br>
pursue it further at that time, but the problem still exists.  The reason I mentioned this again in<br>
the current thread is that I speculate that the abnormal termination of an external prover in this way<br>
could be the origin of leaked storage in the ML heap.</p>
<p>- Gene Stark</p>
<p><a href="/user_uploads/14278/ioD53IMerCysU3hvDfSc4Qrt/OpenPGP_signature">OpenPGP_signature</a></p>



<a name="354999701"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Heavy%20memory%20use%20with%20sledgehammer/near/354999701" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Heavy.20memory.20use.20with.20sledgehammer.html#354999701">(May 02 2023 at 00:28)</a>:</h4>
<p>From: "Eugene W. Stark" &lt;<a href="mailto:isabelle-users@starkeffect.com">isabelle-users@starkeffect.com</a>&gt;<br>
Since doing live monitoring was suggested, I've attached a screenshot showing an example of the<br>
"ML Cleanup lockup" situation.  I went away and was eating dinner and watching television<br>
(on a different computer) and I came back after about an hour to see this.  There are 10 cores<br>
running full tilt, according to "top", but the monitor panel does not seem to show anything<br>
happening.  The JEdit window shows "ML Cleanup".  ML heap size is near the maximum of 64G<br>
that I have set.</p>
<p>There previously was a "try" in the JEdit editor panel, and you can see the vestigial<br>
"No proof found" in the Output panel.  I had deleted the "try", but this does not recover<br>
the session.  JEdit remains responsive, but gets no updates from ML.</p>
<p>- Gene Stark</p>
<p><a href="/user_uploads/14278/KKs8XErvGstJtt-88R7drE9m/Screenshot-from-2023-05-01-20-23-22.png">Screenshot from 2023-05-01 20-23-22.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/14278/KKs8XErvGstJtt-88R7drE9m/Screenshot-from-2023-05-01-20-23-22.png" title="Screenshot from 2023-05-01 20-23-22.png"><img src="/user_uploads/14278/KKs8XErvGstJtt-88R7drE9m/Screenshot-from-2023-05-01-20-23-22.png"></a></div>



<hr><p>Last updated: Nov 01 2025 at 16:22 UTC</p>
</html>