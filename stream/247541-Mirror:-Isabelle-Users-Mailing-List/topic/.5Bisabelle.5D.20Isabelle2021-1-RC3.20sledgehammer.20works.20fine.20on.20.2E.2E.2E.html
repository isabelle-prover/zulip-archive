<html>
<head><meta charset="utf-8"><title>[isabelle] Isabelle2021-1-RC3 sledgehammer works fine on ... · Mirror: Isabelle Users Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/index.html">Mirror: Isabelle Users Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html">[isabelle] Isabelle2021-1-RC3 sledgehammer works fine on ...</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="261314805"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261314805" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261314805">(Nov 12 2021 at 21:44)</a>:</h4>
<p>From: Frédéric Boulanger &lt;<a href="mailto:frederic.boulanger@centralesupelec.fr">frederic.boulanger@centralesupelec.fr</a>&gt;<br>
Hello,</p>
<p>I just installed the RC3 release for arm64 in a Docker container running <br>
on an Apple M1 chip, and the issues I had with sledgehammer in RC1 seem <br>
to be fixed.</p>
<p>It works fine and provides better proofs than in Isabelle2021 on an <br>
Intel chip.</p>
<p>Many thanks for this!</p>
<p>The MacOS version works fine on both Intel and M1 machines, but I wonder <br>
if it takes advantage of the M1 chip. It is shown as an Intel <br>
application on both platforms, but I see arm64-darwin directories in the <br>
packaged polyml-5.9 and jdk-17 distributions, so the support for the M1 <br>
chip may be quite good although the NEWS file let me think that the <br>
Intel version of Poly/ML is still used through Rosetta 2.</p>
<p>Frédéric</p>



<a name="261317569"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261317569" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261317569">(Nov 12 2021 at 22:07)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On 12/11/2021 22:43, Frédéric Boulanger wrote:</p>
<blockquote>
<p>I just installed the RC3 release for arm64 in a Docker container running on an<br>
Apple M1 chip, and the issues I had with sledgehammer in RC1 seem to be fixed.</p>
<p>It works fine and provides better proofs than in Isabelle2021 on an Intel chip.</p>
<p>Many thanks for this!</p>
</blockquote>
<p>Great. The thanks need to be directed towards David Matthews, who is refining<br>
Poly/ML 5.9 towards a release where ARM will work natively (on Linux, macOS,<br>
Windows), but be still somewhat inefficiently due to lack of code optimization.</p>
<blockquote>
<p>The MacOS version works fine on both Intel and M1 machines, but I wonder if it<br>
takes advantage of the M1 chip. It is shown as an Intel application on both<br>
platforms, but I see arm64-darwin directories in the packaged polyml-5.9 and<br>
jdk-17 distributions, so the support for the M1 chip may be quite good<br>
although the NEWS file let me think that the Intel version of Poly/ML is still<br>
used through Rosetta 2.</p>
</blockquote>
<p>I have already built many components for arm64-linux, and a few for<br>
arm64-darwin (external provers etc.).</p>
<p>Java 15 in Isabelle2021 has already been native arm64-darwin, and this<br>
continues with Java 17 in Isabelle2021-1.</p>
<p>In contrast, the native Poly/ML arm64_32-darwin (and arm64-darwin) is only<br>
there for testing, to sort out remaining problems. On macOS, x86_64_32-darwin<br>
performs much better with Rosetta 2 and will remain the default for now.</p>
<p>You can try ARM by augmenting $ISABELLE_HOME_USER/etc/settings like this:</p>
<p>ML_PLATFORM="arm64_32-darwin"<br>
ML_HOME="$POLYML_HOME/$ML_PLATFORM"</p>
<p>This will build an image for Isabelle/HOL on startup of Isabelle/jEdit.</p>
<p>Makarius</p>



<a name="261371266"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261371266" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261371266">(Nov 13 2021 at 17:33)</a>:</h4>
<p>From: David Matthews &lt;<a href="mailto:dm@prolingua.co.uk">dm@prolingua.co.uk</a>&gt;<br>
I'm pleased it works well for you.  The ARM64 port involves quite a few <br>
components.  The focus so far has been on getting the essential parts <br>
working, tested and fixing bugs.  Register optimisation isn't critical <br>
so that has been left for the moment.  As a result the ARM64 port <br>
doesn't perform quite as well as the X86 version with Rosetta. <br>
Hopefully that will change when there has been time to work on optimisation.</p>
<p>David</p>



<a name="261379956"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261379956" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261379956">(Nov 13 2021 at 21:05)</a>:</h4>
<p>From: Frédéric Boulanger &lt;<a href="mailto:frederic.boulanger@centralesupelec.fr">frederic.boulanger@centralesupelec.fr</a>&gt;<br>
Thank you for the explanations, and the good work!</p>
<p>I provide my students with a Docker image containing all the software <br>
they need for the year, and some of them have MacBooks with M1 chips so <br>
they need the arm64-linux version of the image.</p>
<p>I did not make extensive tests and only checked that what I need for my <br>
courses works. I also managed to build the Why3 &lt;<a href="http://why3.lri.fr/">http://why3.lri.fr/</a>&gt; <br>
Isabelle session in which many proofs "by smt" failed with RC1, so I <br>
guess it is all the interface with smt solvers that benefits from the <br>
work on Poly/ML.</p>
<p>Frédéric</p>



<a name="261540239"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261540239" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261540239">(Nov 15 2021 at 18:37)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
Poly/ML on arm64 is one thing, and external provers are another thing. I have<br>
successfully built most tools for arm64-linux, with the following exceptions:</p>
<p>. cvc4<br>
    . z3<br>
    . nunchaku<br>
    . smbc</p>
<p>The default for the "smt" proof method is z3, but veriT is getting more and<br>
more significant, which is already on arm64-linux.</p>
<p>After spending many hours with z3-4.4.0 and z3-4.4.1, which are both quite old<br>
but close to our current component z3-4.4.0pre-3, I've come to the conclusion<br>
that supporting z3 on arm64-linux requires a proper update to a current<br>
version <a href="https://github.com/Z3Prover/z3/tags">https://github.com/Z3Prover/z3/tags</a></p>
<p>We cannot warp the underlying z3 several years from distant past into the<br>
present, without significant work on the Isabelle side.</p>
<p>So for Isabelle2021-1-RC1 nothing is going to happen --- unless you come up<br>
with a patch for z3-4.4.0 or z3-4.4.1 (based on the included one for 4.4.1).</p>
<p>Makarius<br>
<a href="/user_uploads/14278/GkWtTPrQzlVI7W4vkX1ed0o1/a.patch">a.patch</a></p>



<a name="261548116"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261548116" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261548116">(Nov 15 2021 at 19:38)</a>:</h4>
<p>From: Florian Märkl &lt;<a href="mailto:isabelle-users@florianmaerkl.de">isabelle-users@florianmaerkl.de</a>&gt;<br>
Hello Makarius,</p>
<blockquote>
<p>So for Isabelle2021-1-RC1 nothing is going to happen --- unless you come up<br>
with a patch for z3-4.4.0 or z3-4.4.1 (based on the included one for 4.4.1).</p>
</blockquote>
<p>I have compiled the old z3-4.4.0 a while ago for playing around with native arm64 Isabelle.<br>
Luckily I just found my patches are still there, so I have attached them.<br>
Iirc, in addition to very similar patches as you have done already, I just did a recursive sed replacing __in by __z3_in and __out by __z3_out.<br>
It can be built like this:</p>
<p>CC=clang CXX=clang++ python scripts/mk_make.py &amp;&amp; \<br>
sed -i 's/-msse2//g' build/config.mk &amp;&amp; \<br>
sed -i 's/-msse//g' build/config.mk &amp;&amp; \<br>
sed -i 's/-mfpmath=sse//g' build/config.mk &amp;&amp; \<br>
cd build &amp;&amp; \<br>
make -j8</p>
<p>I didn’t bother messing around in their python build system code and instead just remove the x86-specific flags manually in the generated files.<br>
At least this works for me on Gentoo/glibc.</p>
<p>In any case though...</p>
<blockquote>
<p>I've come to the conclusion<br>
that supporting z3 on arm64-linux requires a proper update to a current<br>
version <a href="https://github.com/Z3Prover/z3/tags">https://github.com/Z3Prover/z3/tags</a></p>
<p>We cannot warp the underlying z3 several years from distant past into the<br>
present, without significant work on the Isabelle side.<br>
I do agree on this in the long run. These are really just dirty hacks.</p>
</blockquote>
<p>Florian<br>
<a href="/user_uploads/14278/9v48lzzhjlEKCLrfYruWot3u/0001-arm64-patches.patch">0001-arm64-patches.patch</a></p>



<a name="261551100"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261551100" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261551100">(Nov 15 2021 at 20:01)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On 15/11/2021 20:38, Florian Märkl wrote:</p>
<blockquote>
<blockquote>
<p>So for Isabelle2021-1-RC1 nothing is going to happen --- unless you come up<br>
with a patch for z3-4.4.0 or z3-4.4.1 (based on the included one for 4.4.1).</p>
</blockquote>
<p>I have compiled the old z3-4.4.0 a while ago for playing around with native arm64 Isabelle.<br>
Luckily I just found my patches are still there, so I have attached them.<br>
Iirc, in addition to very similar patches as you have done already, I just did a recursive sed replacing __in by __z3_in and __out by __z3_out.</p>
</blockquote>
<p>Can you explain the purpose of __z3_in and __z3_out?</p>
<blockquote>
<p>It can be built like this:</p>
<p>CC=clang CXX=clang++ python scripts/mk_make.py &amp;&amp; \<br>
sed -i 's/-msse2//g' build/config.mk &amp;&amp; \<br>
sed -i 's/-msse//g' build/config.mk &amp;&amp; \<br>
sed -i 's/-mfpmath=sse//g' build/config.mk &amp;&amp; \<br>
cd build &amp;&amp; \<br>
make -j8</p>
</blockquote>
<p>I did not try the alternative clang setup yet.</p>
<p>With the default gcc incantations, it all builds, but in the very end there is<br>
a final error:</p>
<p>ontend.o shell/main.o shell/mem_initializer.o shell/smtlib_frontend.o<br>
shell/gparams_register_modules.o api/api.a opt/opt.a parsers/smt/smtparser.a<br>
tactic/portfolio/portfolio.a sat/sat_solver/sat_solver.a<br>
tactic/ufbv/ufbv_tactic.a tactic/fpa/fpa_tactics.a<br>
tactic/smtlogics/smtlogic_tactics.a tactic/nlsat_smt/nlsat_smt_tactic.a<br>
muz/fp/fp.a muz/duality/duality_intf.a muz/ddnf/ddnf.a muz/bmc/bmc.a<br>
muz/tab/tab.a muz/clp/clp.a muz/pdr/pdr.a muz/rel/rel.a<br>
muz/transforms/transforms.a muz/dataflow/dataflow.a muz/base/muz.a<br>
duality/duality.a qe/qe.a tactic/sls/sls_tactic.a smt/tactic/smt_tactic.a<br>
tactic/bv/bv_tactics.a smt/user_plugin/user_plugin.a smt/smt.a<br>
smt/proto_model/proto_model.a smt/params/smt_params.a<br>
ast/rewriter/bit_blaster/bit_blaster.a ast/pattern/pattern.a<br>
ast/macros/macros.a ast/fpa/fpa.a ast/simplifier/simplifier.a<br>
ast/proof_checker/proof_checker.a parsers/smt2/smt2parser.a<br>
cmd_context/extra_cmds/extra_cmds.a cmd_context/cmd_context.a interp/interp.a<br>
solver/solver.a tactic/aig/aig_tactic.a<br>
math/subpaving/tactic/subpaving_tactic.a nlsat/tactic/nlsat_tactic.a<br>
tactic/arith/arith_tactics.a sat/tactic/sat_tactic.a<br>
tactic/core/core_tactics.a math/euclid/euclid.a math/grobner/grobner.a<br>
parsers/util/parser_util.a ast/substitution/substitution.a tactic/tactic.a<br>
model/model.a ast/normal_forms/normal_forms.a ast/rewriter/rewriter.a<br>
ast/ast.a math/subpaving/subpaving.a math/realclosure/realclosure.a<br>
math/interval/interval.a math/simplex/simplex.a math/hilbert/hilbert.a<br>
nlsat/nlsat.a sat/sat.a math/polynomial/polynomial.a util/util.a  -lpthread<br>
-fopenmp -lrt<br>
/usr/bin/ld: smt/smt.a(smt_statistics.o): Relocations in generic ELF (EM: 62)<br>
/usr/bin/ld: smt/smt.a(smt_statistics.o): Relocations in generic ELF (EM: 62)<br>
/usr/bin/ld: smt/smt.a(smt_statistics.o): Relocations in generic ELF (EM: 62)<br>
/usr/bin/ld: smt/smt.a: error adding symbols: file in wrong format<br>
collect2: error: ld returned 1 exit status<br>
make: *** [Makefile:3520: z3] Error 1</p>
<p>I will try clang, but it takes all very long on this tiny Raspberrypi device.</p>
<p>Makarius</p>



<a name="261552856"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261552856" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261552856">(Nov 15 2021 at 20:15)</a>:</h4>
<p>From: Florian Märkl &lt;<a href="mailto:isabelle-users@florianmaerkl.de">isabelle-users@florianmaerkl.de</a>&gt;</p>
<blockquote>
<p>Am 15.11.2021 um 21:01 schrieb Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;:</p>
<p>On 15/11/2021 20:38, Florian Märkl wrote:</p>
<blockquote>
<blockquote>
<p>So for Isabelle2021-1-RC1 nothing is going to happen --- unless you come up<br>
with a patch for z3-4.4.0 or z3-4.4.1 (based on the included one for 4.4.1).</p>
</blockquote>
<p>I have compiled the old z3-4.4.0 a while ago for playing around with native arm64 Isabelle.<br>
Luckily I just found my patches are still there, so I have attached them.<br>
Iirc, in addition to very similar patches as you have done already, I just did a recursive sed replacing __in by __z3_in and __out by __z3_out.</p>
</blockquote>
<p>Can you explain the purpose of __z3_in and __z3_out?</p>
</blockquote>
<p>Just from a quick glance at the code I think they are just hints for the reader to mark function arguments as inputs or outputs.<br>
They are defined to nothing and my assumption seems to match their usage. So they could essentially be removed entirely as well.</p>
<blockquote>
<p>I will try clang, but it takes all very long on this tiny Raspberrypi device.</p>
</blockquote>
<p>The clang version I used, in case it helps:<br>
clang version 12.0.1<br>
Target: aarch64-unknown-linux-gnu<br>
Thread model: posix<br>
InstalledDir: /usr/lib/llvm/12/bin<br>
Selected GCC installation: /usr/lib/gcc/aarch64-unknown-linux-gnu/11.1.0<br>
Candidate multilib: .;@m64<br>
Selected multilib: .;@m64</p>
<p>Florian</p>



<a name="261564086"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247541-Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Isabelle2021-1-RC3%20sledgehammer%20works%20fine%20on%20.../near/261564086" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247541-Mirror:-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Isabelle2021-1-RC3.20sledgehammer.20works.20fine.20on.20.2E.2E.2E.html#261564086">(Nov 15 2021 at 21:46)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
This is all a bit tedious: my Pi OS installation lacks clang/clang++.</p>
<p>Luckily, there is an existing executable here:<br>
<a href="https://packages.debian.org/stretch/arm64/z3/download">https://packages.debian.org/stretch/arm64/z3/download</a></p>
<p>So I will just bundle the binaries as Isabelle component z3-4.4.1 and continue<br>
with that --- so far it looks good.</p>
<p>Makarius</p>



<hr><p>Last updated: Jul 15 2022 at 23:21 UTC</p>
</html>