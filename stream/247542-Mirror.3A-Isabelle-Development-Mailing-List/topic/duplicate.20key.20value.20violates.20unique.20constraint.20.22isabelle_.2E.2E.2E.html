<html>
<head><meta charset="utf-8"><title>duplicate key value violates unique constraint &quot;isabelle_... · Mirror: Isabelle Development Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/index.html">Mirror: Isabelle Development Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html">duplicate key value violates unique constraint &quot;isabelle_...</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="565826940"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/565826940" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#565826940">(Dec 30 2025 at 19:49)</a>:</h4>
<p><strong>From:</strong> Florian Haftmann &lt;<a href="mailto:florian.haftmann@cit.tum.de">florian.haftmann@cit.tum.de</a>&gt;</p>
<p>There is a reproducible break down in the build system:</p>
<p><a href="https://build.proof.cit.tum.de/build?id=038ecd8c-6a3e-4e55-bacd-a455cf7f6b40">https://build.proof.cit.tum.de/build?id=038ecd8c-6a3e-4e55-bacd-a455cf7f6b40</a></p>
<p>A few weeks ago there was a similar break down.</p>
<p>What is going on here?</p>
<p>Thanks a lot,<br>
    Florian</p>
<p><a href="/user_uploads/14278/DKgCQ4OoTKzCCIqfW3ghE7Vw/OpenPGP_0xA707172232CFA4E9.asc">OpenPGP_0xA707172232CFA4E9.asc</a><br>
<a href="/user_uploads/14278/ZqtDiqNJy6pzHYGFUuBMeSH-/OpenPGP_signature.asc">OpenPGP_signature.asc</a></p>



<a name="566001220"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/566001220" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#566001220">(Jan 01 2026 at 21:47)</a>:</h4>
<p><strong>From:</strong> Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;</p>
<p>On 30/12/2025 20:49, Florian Haftmann wrote:</p>
<blockquote>
<p>There is a reproducible break down in the build system:</p>
<p><a href="https://build.proof.cit.tum.de/build?id=038ecd8c-6a3e-4e55-bacd-a455cf7f6b40">https://build.proof.cit.tum.de/build?id=038ecd8c-6a3e-4e55-bacd-a455cf7f6b40</a></p>
</blockquote>
<p>Thanks for the hint. I have now reset the database state of the build server.</p>
<blockquote>
<p>A few weeks ago there was a similar break down.</p>
<p>What is going on here?<br>
There is some fragility in the design and/or implementation of the cluster. <br>
Rather soon, I need to sit down with Fabian Huch, to sort it out.</p>
</blockquote>
<p>Makarius</p>



<a name="566031142"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/566031142" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#566031142">(Jan 02 2026 at 08:16)</a>:</h4>
<p><strong>From:</strong> Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;</p>
<p>Unfortunately the build system has hit the same problem again.</p>
<p>Tobias</p>
<p>On 01/01/2026 22:46, Makarius wrote:</p>
<blockquote>
<p>On 30/12/2025 20:49, Florian Haftmann wrote:</p>
<blockquote>
<p>There is a reproducible break down in the build system:</p>
<p><a href="https://build.proof.cit.tum.de/build?id=038ecd8c-6a3e-4e55-bacd-a455cf7f6b40">https://build.proof.cit.tum.de/build?id=038ecd8c-6a3e-4e55-bacd-a455cf7f6b40</a></p>
</blockquote>
<p>Thanks for the hint. I have now reset the database state of the build server.</p>
<blockquote>
<p>A few weeks ago there was a similar break down.</p>
<p>What is going on here?<br>
There is some fragility in the design and/or implementation of the cluster. <br>
Rather soon, I need to sit down with Fabian Huch, to sort it out.</p>
</blockquote>
<p>Makarius<br>
</p>
</blockquote>
<p><a href="/user_uploads/14278/KSuwvXdsxxluEuh54sLFdCbl/smime.p7s">smime.p7s</a></p>



<a name="566101413"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/566101413" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#566101413">(Jan 02 2026 at 21:08)</a>:</h4>
<p><strong>From:</strong> Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;</p>
<p>On 02/01/2026 09:15, Tobias Nipkow wrote:</p>
<blockquote>
<p>Unfortunately the build system has hit the same problem again.</p>
</blockquote>
<p>I have reset everything once more, and tried "isabelle build_task -a" <br>
successfully.</p>
<p>Hopefully this is sufficient for the rest of the Christmas vacation. I will be <br>
mostly unavailable at least until 07-Jan-2026.</p>
<p>Makarius</p>



<a name="566528723"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/566528723" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#566528723">(Jan 06 2026 at 11:47)</a>:</h4>
<p><strong>From:</strong> Fabian Huch &lt;<a href="mailto:huch@in.tum.de">huch@in.tum.de</a>&gt;</p>
<p>There are two problems here:</p>
<ul>
<li>
<p>the underlying problem is that the Isabelle/Scala process uses up a <br>
lot more memory than it used to, causing OOM errors.</p>
</li>
<li>
<p>the build infrastructure cannot handle build processes that have <br>
abnormally terminated.</p>
</li>
</ul>
<p>To address this, we can:</p>
<p>(1) tune memory settings and investigate into why we're using up so much <br>
more JVM memory than before -- I'll look into that first.</p>
<p>(2) Make the system more robust in the face of such problems. I need to <br>
sit down with Makarius to discuss this.</p>
<p>(3) Make the scheduling aware of memory limitations. The system was <br>
designed such that this is possible, but it requires more work. I'll <br>
work on that once the immediate problems are solved.</p>
<p>Fabian</p>
<p>On 1/2/26 22:08, Makarius wrote:</p>
<blockquote>
<p>On 02/01/2026 09:15, Tobias Nipkow wrote:</p>
<blockquote>
<p>Unfortunately the build system has hit the same problem again.</p>
</blockquote>
<p>I have reset everything once more, and tried "isabelle build_task -a" <br>
successfully.</p>
<p>Hopefully this is sufficient for the rest of the Christmas vacation. I <br>
will be mostly unavailable at least until 07-Jan-2026.</p>
<p>Makarius</p>
</blockquote>



<a name="567728843"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/567728843" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#567728843">(Jan 13 2026 at 10:27)</a>:</h4>
<p><strong>From:</strong> Fabian Huch &lt;<a href="mailto:huch@in.tum.de">huch@in.tum.de</a>&gt;</p>
<p>On 1/6/26 12:46, Fabian Huch wrote:</p>
<blockquote>
<p>There are two problems here:</p>
<ul>
<li>
<p>the underlying problem is that the Isabelle/Scala process uses up a <br>
lot more memory than it used to, causing OOM errors.</p>
</li>
<li>
<p>the build infrastructure cannot handle build processes that have <br>
abnormally terminated.</p>
</li>
</ul>
<p>To address this, we can:</p>
<p>(1) tune memory settings and investigate into why we're using up so <br>
much more JVM memory than before -- I'll look into that first.</p>
</blockquote>
<p>I checked and tuned the system:</p>
<ul>
<li>
<p>we had a rogue Isabelle process on one of the nodes that refused to <br>
terminate, eating up ~30GiB of that machine's RAM</p>
</li>
<li>
<p>I reduced the maximal number of concurrent jobs on our lower-memory <br>
machines (which have 64GiB each)</p>
</li>
</ul>
<p>This worked fine for the past week; however the memory consumption of <br>
the JVM process is still abnormally high.</p>
<p>Looking at memory snapshots of the build, one of the reasons is the <br>
recent incorporation of Node_Status into the progress: command_timings <br>
are stored as</p>
<p>command_timings:Map[Command, Command_Timings]</p>
<p>and the command (in the key) contains large markups, e.g. in <br>
init_markups, during the lifetime of these timings: up to ~1GiB during <br>
the build of the distribution, likely significantly more in an AFP <br>
build. I would propose to only keep the Document_ID.Command here, see <br>
the attached patch.</p>
<p>Fabian</p>
<p><a href="/user_uploads/14278/G_dlDv2UMhHWboCTV_8Af6-Z/node_status_memory.patch">node_status_memory.patch</a></p>



<a name="567756181"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/567756181" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#567756181">(Jan 13 2026 at 12:55)</a>:</h4>
<p><strong>From:</strong> Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;</p>
<p>On 13/01/2026 11:26, Fabian Huch wrote:</p>
<blockquote>
<p>Looking at memory snapshots of the build, one of the reasons is the recent <br>
incorporation of Node_Status into the progress: command_timings are stored as</p>
<p>command_timings:Map[Command, Command_Timings]</p>
<p>and the command (in the key) contains large markups, e.g. in init_markups, <br>
during the lifetime of these timings: up to ~1GiB during the build of the <br>
distribution, likely significantly more in an AFP build.<br>
Thanks for the measurements. I've already suspected a problem exactly there, <br>
but did not know how to do memory profiling on the JVM.</p>
</blockquote>
<p>Can you give some hints on how to do that?</p>
<p>Makarius</p>



<a name="567782091"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/567782091" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#567782091">(Jan 13 2026 at 14:45)</a>:</h4>
<p><strong>From:</strong> Fabian Huch &lt;<a href="mailto:huch@in.tum.de">huch@in.tum.de</a>&gt;</p>
<p>On 1/13/26 13:54, Makarius wrote:</p>
<blockquote>
<p>On 13/01/2026 11:26, Fabian Huch wrote:</p>
<blockquote>
<p>Looking at memory snapshots of the build, one of the reasons is the <br>
recent incorporation of Node_Status into the progress: <br>
command_timings are stored as</p>
<p>command_timings:Map[Command, Command_Timings]</p>
<p>and the command (in the key) contains large markups, e.g. in <br>
init_markups, during the lifetime of these timings: up to ~1GiB <br>
during the build of the distribution, likely significantly more in an <br>
AFP build.<br>
Thanks for the measurements. I've already suspected a problem exactly <br>
there, but did not know how to do memory profiling on the JVM.</p>
</blockquote>
<p>Can you give some hints on how to do that?</p>
<p>I usually do this by analyzing multiple heap dumps of the JVM during the <br>
run. Those can be generated either from within the JVM, like so:</p>
</blockquote>
<p>def dump_heap(file: Path, include_live: Boolean =true): Unit = {<br>
   val mxBean = java.lang.management.ManagementFactory.getPlatformMXBean(<br>
     classOf[com.sun.management.HotSpotDiagnosticMXBean])<br>
   mxBean.dumpHeap(file.absolute.implode, include_live)<br>
}</p>
<p>or by instructing the JVM from the outside, e.g. via 'jmap <br>
-dump:format=b,file=heap.hprof &lt;pid&gt;'</p>
<p>These heap dumps can then be analyzed with tools such as Eclipse MAT or <br>
JProfiler, in particular by:</p>
<ul>
<li>
<p>looking at histograms of object classes and their shallow heap <br>
size/retained heap size, e.g. here you see that command markups retain <br>
~1GiB of heap:</p>
</li>
<li>
<p>analyzing the memory graph through tree views, e.g. here you can see <br>
what why the command markups are retained (there is a delayed event to <br>
update the progress, where the largest Command key has ~16MiB init_markups):</p>
</li>
</ul>
<p>However, I couldn't get MAT to ignore the weak references of our XML <br>
cache (displayed as object with largest retained heap); this makes it <br>
far less useful here.</p>
<p>Perhaps this is possible by tinkering with the options, but I don't know <br>
how -- I used to work with JProfiler, but that is commercial.</p>
<p>Fabian</p>
<p><a href="/user_uploads/14278/VIdYsJYWgmBej6qDdlGtpsi_/xVNQjnDCttesdZ9N.png">xVNQjnDCttesdZ9N.png</a><br>
<a href="/user_uploads/14278/CgNDCUOeHhb34CdrR_K4JamR/IWTyC0NJNa2j0viE.png">IWTyC0NJNa2j0viE.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/14278/VIdYsJYWgmBej6qDdlGtpsi_/xVNQjnDCttesdZ9N.png" title="xVNQjnDCttesdZ9N.png"><img data-original-content-type="image/png" data-original-dimensions="702x495" src="/user_uploads/thumbnail/14278/VIdYsJYWgmBej6qDdlGtpsi_/xVNQjnDCttesdZ9N.png/840x560.webp"></a></div><div class="message_inline_image"><a href="/user_uploads/14278/CgNDCUOeHhb34CdrR_K4JamR/IWTyC0NJNa2j0viE.png" title="IWTyC0NJNa2j0viE.png"><img data-original-content-type="image/png" data-original-dimensions="1053x738" src="/user_uploads/thumbnail/14278/CgNDCUOeHhb34CdrR_K4JamR/IWTyC0NJNa2j0viE.png/840x560.webp"></a></div>



<a name="568073274"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/568073274" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#568073274">(Jan 14 2026 at 20:23)</a>:</h4>
<p><strong>From:</strong> Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;</p>
<p>On 13/01/2026 11:26, Fabian Huch wrote:</p>
<blockquote>
<p>Looking at memory snapshots of the build, one of the reasons is the recent <br>
incorporation of Node_Status into the progress: command_timings are stored as</p>
<p>command_timings:Map[Command, Command_Timings]</p>
<p>and the command (in the key) contains large markups, e.g. in init_markups, <br>
during the lifetime of these timings: up to ~1GiB during the build of the <br>
distribution, likely significantly more in an AFP build. I would propose to <br>
only keep the Document_ID.Command here, see the attached patch.</p>
</blockquote>
<p>See now:</p>
<p>changeset:   83825:3ed2781b1cc5<br>
user:        wenzelm<br>
date:        Wed Jan 14 13:09:47 2026 +0100<br>
files:       src/Pure/PIDE/document_status.scala <br>
src/Tools/jEdit/src/timing_dockable.scala<br>
description:<br>
more frugal persistent data, notably for batch builds --- proposed by Fabian <br>
Huch, after Java heap measurements (see also 3f6280aedbcc, a110e7e24e55, <br>
9cc5d77d505c);</p>
<p>It is your original change, with my explanation from the history. I've added a <br>
few more changes on top, but they don't make a fundamental difference.</p>
<p>Note that I did not repeat any performance measurements. I want to do this <br>
eventually, also to see if other problems are present.</p>
<p>Makarius</p>



<a name="568620662"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/568620662" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#568620662">(Jan 17 2026 at 22:35)</a>:</h4>
<p><strong>From:</strong> Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;</p>
<p>On 14/01/2026 21:22, Makarius wrote:</p>
<blockquote>
<p>See now:</p>
<p>changeset:   83825:3ed2781b1cc5<br>
user:        wenzelm<br>
date:        Wed Jan 14 13:09:47 2026 +0100<br>
files:       src/Pure/PIDE/document_status.scala src/Tools/jEdit/src/ <br>
timing_dockable.scala<br>
description:<br>
more frugal persistent data, notably for batch builds --- proposed by Fabian <br>
Huch, after Java heap measurements (see also 3f6280aedbcc, a110e7e24e55, <br>
9cc5d77d505c);</p>
<p>It is your original change, with my explanation from the history. I've added a <br>
few more changes on top, but they don't make a fundamental difference.</p>
<p>Note that I did not repeat any performance measurements. I want to do this <br>
eventually, also to see if other problems are present.</p>
</blockquote>
<p>I have now done some measurements with "isabelle build -o threads=8 -j2 -a -f" <br>
on my Linux box (16 cores), using the included patch for the Isabelle/Scala <br>
implementation of "isabelle build".</p>
<p>The Scala/Java process uses these settings:</p>
<p>ISABELLE_TOOL_JAVA_OPTIONS="-Djava.awt.headless=true -Xms512m -Xmx4g <br>
-Xss16m -XX:+UseZGC -XX:+ZGenerational -XX:SoftMaxHeapSize=2g"</p>
<p>Attached is raw data from the parent of 3ed2781b1cc5 (1), and from <br>
3ed2781b1cc5 (2). The diagram.png is from gnuplot:</p>
<p>plot '1.dat' using 1:2 smooth sbezier title "1 heap_size" noenhanced, <br>
'1.dat' using 1:3 smooth sbezier title "1 heap_used" noenhanced, '2.dat' using <br>
1:2 smooth sbezier title "2 heap_size" noenhanced, '2.dat' using 1:3 smooth <br>
sbezier title "2 heap_used" noenhanced</p>
<p>Conclusion: There is nothing interesting to be seen here. The change hardly <br>
makes a difference.</p>
<p>It could mean that occurrences of Document_ID.Command and Command are in <br>
1-to-1 correspondence on the heap, i.e. no stored Command is later updated/copied.</p>
<p>Or it could mean that I've got something wrong in the experimental setup.</p>
<p>Makarius</p>
<p><a href="/user_uploads/14278/1RbinuCl2VNN0pAaYRhRgH7m/ch">ch</a><br>
<a href="/user_uploads/14278/m908CwFbPvEA554IT7QB-n6h/1.dat.xz">1.dat.xz</a><br>
<a href="/user_uploads/14278/iwSdvGOaElhobJcmNBTpfQWp/2.dat.xz">2.dat.xz</a><br>
<a href="/user_uploads/14278/GQFHuupDCnW7TkZeRqVcpr5s/diagram.png">diagram.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/14278/GQFHuupDCnW7TkZeRqVcpr5s/diagram.png" title="diagram.png"><img data-original-content-type="image/png" data-original-dimensions="1938x639" src="/user_uploads/thumbnail/14278/GQFHuupDCnW7TkZeRqVcpr5s/diagram.png/840x560.webp"></a></div>



<a name="568666257"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/568666257" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#568666257">(Jan 18 2026 at 14:13)</a>:</h4>
<p><strong>From:</strong> Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;</p>
<p>On 14/01/2026 21:22, Makarius wrote:</p>
<blockquote>
<p>See now:</p>
<p>changeset:   83825:3ed2781b1cc5<br>
user:        wenzelm<br>
date:        Wed Jan 14 13:09:47 2026 +0100<br>
files:       src/Pure/PIDE/document_status.scala src/Tools/jEdit/src/ <br>
timing_dockable.scala<br>
description:<br>
more frugal persistent data, notably for batch builds --- proposed by Fabian <br>
Huch, after Java heap measurements (see also 3f6280aedbcc, a110e7e24e55, <br>
9cc5d77d505c);</p>
<p>It is your original change, with my explanation from the history. I've added a <br>
few more changes on top, but they don't make a fundamental difference.</p>
<p>Note that I did not repeat any performance measurements. I want to do this <br>
eventually, also to see if other problems are present.</p>
</blockquote>
<p>I have now done some measurements with "isabelle build -o threads=8 -j2 -a -f" <br>
on my Linux box (16 cores), using the included patch for the Isabelle/Scala <br>
implementation of "isabelle build".</p>
<p>The Scala/Java process uses these settings:</p>
<p>ISABELLE_TOOL_JAVA_OPTIONS="-Djava.awt.headless=true -Xms512m -Xmx4g <br>
-Xss16m -XX:+UseZGC -XX:+ZGenerational -XX:SoftMaxHeapSize=2g"</p>
<p>Attached is raw data 1.dat from the parent of 3ed2781b1cc5, and 2.dat from <br>
3ed2781b1cc5. The diagram.png is from gnuplot:</p>
<p>plot '1.dat' using 1:2 smooth sbezier title "1 heap_size" noenhanced, <br>
'1.dat' using 1:3 smooth sbezier title "1 heap_used" noenhanced, '2.dat' using <br>
1:2 smooth sbezier title "2 heap_size" noenhanced, '2.dat' using 1:3 smooth <br>
sbezier title "2 heap_used" noenhanced</p>
<p>Conclusion: There is nothing interesting to be seen here. The change hardly <br>
makes a difference.</p>
<p>It could mean that occurrences of Document_ID.Command and Command are in <br>
1-to-1 correspondence on the heap, i.e. no stored Command is later updated/copied.</p>
<p>Or it could mean that I've got something wrong in the experimental setup.</p>
<p>Makarius</p>
<p><a href="/user_uploads/14278/Ogkahrk14D2bH7PVWApZYykI/ch">ch</a><br>
<a href="/user_uploads/14278/Q1w5le9uXVDtgITW8Xt5BRA1/1.dat">1.dat</a><br>
<a href="/user_uploads/14278/qj0cTpWU_dUk5w0GqOLrYKFL/2.dat">2.dat</a><br>
<a href="/user_uploads/14278/dE9pydfWo5Bwzjo8v0MA-hnt/diagram.png">diagram.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/14278/dE9pydfWo5Bwzjo8v0MA-hnt/diagram.png" title="diagram.png"><img data-original-content-type="image/png" data-original-dimensions="1938x639" src="/user_uploads/thumbnail/14278/dE9pydfWo5Bwzjo8v0MA-hnt/diagram.png/840x560.webp"></a></div>



<a name="568779055"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/247542-Mirror%3A%20Isabelle%20Development%20Mailing%20List/topic/duplicate%20key%20value%20violates%20unique%20constraint%20%22isabelle_.../near/568779055" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/247542-Mirror.3A-Isabelle-Development-Mailing-List/topic/duplicate.20key.20value.20violates.20unique.20constraint.20.22isabelle_.2E.2E.2E.html#568779055">(Jan 19 2026 at 11:28)</a>:</h4>
<p><strong>From:</strong> Fabian Huch &lt;<a href="mailto:huch@in.tum.de">huch@in.tum.de</a>&gt;</p>
<p>On 1/17/26 23:34, Makarius wrote:</p>
<blockquote>
<p>On 14/01/2026 21:22, Makarius wrote:</p>
<blockquote>
<p>See now:</p>
<p>changeset:   83825:3ed2781b1cc5<br>
user:        wenzelm<br>
date:        Wed Jan 14 13:09:47 2026 +0100<br>
files:       src/Pure/PIDE/document_status.scala src/Tools/jEdit/src/ <br>
timing_dockable.scala<br>
description:<br>
more frugal persistent data, notably for batch builds --- proposed by <br>
Fabian Huch, after Java heap measurements (see also 3f6280aedbcc, <br>
a110e7e24e55, 9cc5d77d505c);</p>
<p>It is your original change, with my explanation from the history. <br>
I've added a few more changes on top, but they don't make a <br>
fundamental difference.</p>
<p>Note that I did not repeat any performance measurements. I want to do <br>
this eventually, also to see if other problems are present.</p>
</blockquote>
<p>I have now done some measurements with "isabelle build -o threads=8 <br>
-j2 -a -f" on my Linux box (16 cores), using the included patch for <br>
the Isabelle/Scala implementation of "isabelle build".</p>
<p>The Scala/Java process uses these settings:</p>
<p>ISABELLE_TOOL_JAVA_OPTIONS="-Djava.awt.headless=true -Xms512m <br>
-Xmx4g -Xss16m -XX:+UseZGC -XX:+ZGenerational -XX:SoftMaxHeapSize=2g"</p>
<p>Attached is raw data from the parent of 3ed2781b1cc5 (1), and from <br>
3ed2781b1cc5 (2). The diagram.png is from gnuplot:</p>
<p>plot '1.dat' using 1:2 smooth sbezier title "1 heap_size" <br>
noenhanced, '1.dat' using 1:3 smooth sbezier title "1 heap_used" <br>
noenhanced, '2.dat' using 1:2 smooth sbezier title "2 heap_size" <br>
noenhanced, '2.dat' using 1:3 smooth sbezier title "2 heap_used" <br>
noenhanced</p>
<p>Conclusion: There is nothing interesting to be seen here. The change <br>
hardly makes a difference.</p>
<p>It could mean that occurrences of Document_ID.Command and Command are <br>
in 1-to-1 correspondence on the heap, i.e. no stored Command is later <br>
updated/copied.</p>
</blockquote>
<p>Hm. I had measured a small number of samples (since heap snapshots are <br>
expensive and large) before and after the change and looked at the heap <br>
composition. But it is possible that the (consistently) lower heap size <br>
was coincidental, and the extended lifetime of these Command markups did <br>
not actually matter -- I'll have to figure out how to properly deal with <br>
our opaque cache in MAT.</p>
<blockquote>
<p>Or it could mean that I've got something wrong in the experimental setup.</p>
</blockquote>
<p>One problem with this experimental setup is that current heap size is <br>
not a good metric for such a high-throughput application (most memory <br>
used would actually be dead).</p>
<p>Also, the smoothing hides what is going on, e.g. when the heap limit is <br>
hit (cf. plot for 1 below). I would rather use the MXBeans of the <br>
garbage collector to obtain GC events and plot a proper peak-to-peak curve.</p>
<p>Fabian</p>
<p><a href="/user_uploads/14278/7xL8T6sT35JVd39p0b67i27g/eY93XwRiR134kXXF.png">eY93XwRiR134kXXF.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/14278/7xL8T6sT35JVd39p0b67i27g/eY93XwRiR134kXXF.png" title="eY93XwRiR134kXXF.png"><img data-original-content-type="image/png" data-original-dimensions="2048x735" src="/user_uploads/thumbnail/14278/7xL8T6sT35JVd39p0b67i27g/eY93XwRiR134kXXF.png/840x560.webp"></a></div>



<hr><p>Last updated: Feb 22 2026 at 20:30 UTC</p>
</html>