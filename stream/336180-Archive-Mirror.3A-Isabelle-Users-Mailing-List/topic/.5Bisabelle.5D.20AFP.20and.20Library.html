<html>
<head><meta charset="utf-8"><title>[isabelle] AFP and Library · Archive Mirror: Isabelle Users Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/index.html">Archive Mirror: Isabelle Users Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html">[isabelle] AFP and Library</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294715830"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294715830" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294715830">(Aug 22 2022 at 15:55)</a>:</h4>
<p>From: Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;<br>
Hi Makarius,</p>
<p>You have concerted many if not all AFP sessions that use theories from Library <br>
such that they are now based on the Library image. This means that every time a <br>
Library theory changes, sonething like half the AFP needs to be rebuilt even <br>
though only a few of the AFP sessions may import the modified Library theory. <br>
This happens fairly frequently and I wonder what your rational for the change was.</p>
<p>Tobias<br>
<a href="/user_uploads/14278/Hfa0s-9JO0ggBdS-TFdixcEe/smime.p7s">smime.p7s</a></p>



<a name="294715891"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294715891" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294715891">(Aug 22 2022 at 15:56)</a>:</h4>
<p>From: Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;<br>
Gerwin wrote:</p>
<p>"Most AFP entries were already based on that, because we’d otherwise be building <br>
HOL-Library about 50 times or so instead of only once per test. It’s a trade-off."</p>
<p>Well, we would only be building a few popular entries in Library multiple times. <br>
Indeed it is a trade-off and we win a little(?) by starting from a Library image <br>
but we lose big time if only a single theory in Library changes. It is a bit <br>
like amortized complexity: on average, you win, but in real time you may have to <br>
wait much longer. Since Library changes frequently, I do wonder about this <br>
trade-off.</p>
<p>Tobias<br>
<a href="/user_uploads/14278/WOGvOnpMbcCD_YHhy0t4qra4/smime.p7s">smime.p7s</a></p>



<a name="294715916"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294715916" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294715916">(Aug 22 2022 at 15:56)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;<br>
Just as a side note for your consideration: Jenkins builds the AFP incrementally, i.e., only changed sessions. A change in HOL-Library will entail a lot of sessions being rebuilt, even if just a single theory has changed.</p>
<p>Maybe we should look into which library theories change the most or split library into multiple sessions.</p>
<p>Cheers<br>
Lars</p>



<a name="294715934"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294715934" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294715934">(Aug 22 2022 at 15:56)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;<br>
Just as a side note for your consideration: Jenkins builds the AFP incrementally, i.e., only changed sessions. A change in HOL-Library will entail a lot of sessions being rebuilt, even if just a single theory has changed.</p>
<p>Maybe we should look into which library theories change the most or split library into multiple sessions.</p>
<p>Cheers<br>
Lars</p>



<a name="294715949"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294715949" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294715949">(Aug 22 2022 at 15:56)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On 28/08/17 08:15, Tobias Nipkow wrote:</p>
<blockquote>
<p>Gerwin wrote:</p>
<p>"Most AFP entries were already based on that, because we’d otherwise be<br>
building HOL-Library about 50 times or so instead of only once per test.<br>
It’s a trade-off."</p>
</blockquote>
<p>This is indeed the traditional explanation for providing various<br>
"library" images in Isabelle and using them in the applications, e.g. in<br>
AFP. In recent years we have seen a trend of increasing that quite<br>
substantially.</p>
<p>In particular, Isabelle2017 will have the following important starting<br>
points for applications:</p>
<p>HOL<br>
  HOL-Library<br>
  HOL-Computational-Algebra<br>
  HOL-Analysis | HOL-Algebra | HOL-Number_Theory | HOL-Nonstandard-Analysis</p>
<p>After changing any of them, there will be substantial follow-up build<br>
times of other sessions depending on them. This is a natural consequence<br>
of providing good library sessions and getting lots of applications on top.</p>
<p>There is a second aspect for the HOL-Library image only: it is somehow<br>
the canonical supplement to the main HOL image.</p>
<p>Thus there are occasional tendencies in the applications to provide a<br>
session "Foo" and also "Foo-Library" that "merges" the HOL-Library<br>
aspect later on, even after building a whole stack of sessions. This<br>
complicates session specifications and causes further multiplication of<br>
build times. Since we cannot really merge session images, the main<br>
approach to avoid the problem is to put HOL-Library at the very start of<br>
the session dependencies and to remove the Foo-Library variant eventually.</p>
<blockquote>
<p>Well, we would only be building a few popular entries in Library<br>
multiple times. Indeed it is a trade-off and we win a little(?) by<br>
starting from a Library image but we lose big time if only a single<br>
theory in Library changes.</p>
</blockquote>
<p>This sounds more like the file-based build model of Coq, but without<br>
actual "object files" to store intermediate states.</p>
<p>It is a theoretical question if we can move over there, practically we<br>
can't change the fundamental approache on the spot and expect that<br>
things still work afterwards.</p>
<p>(I have occasionally discussed the inherent differences of the build<br>
model with the Coq guys, and am still convinced that our tradition of<br>
doing it scales better. Empirical proof: size and complexity of AFP today.)</p>
<p>I do agree that in the past 1-2 years there is an increasing pain to be<br>
felt in maintaining Isabelle + AFP, up to the point that less<br>
maintenance and fewer important reforms happen. In the past 3 years, the<br>
size of Isabelle + AFP material has doubled, while build and test<br>
infrastructure had stagnated since 2012. Only recently this has improved<br>
again (but I don't mean the Jenkins setup, which I simply ignore).</p>
<p>What would greatly help is to have proper time measurement for nightly<br>
builds of AFP within the regular Isabelle cronjob, with its persistent<br>
database support in the background (see also<br>
<a href="http://isabelle.in.tum.de/devel/build_status">http://isabelle.in.tum.de/devel/build_status</a>). The software is all there<br>
in Isabelle/Scala; lacking is only some half-decent test hardware (e.g.<br>
a cloud node with 8 cores + 64 GB should be sufficient).</p>
<p>At some point, "isabelle build" could use the persistent timing<br>
information from the database to make better scheduling of big builds,<br>
including adhoc changes to the actual session graph (e.g. changing<br>
parent sessions vs. session imports).</p>
<p>Makarius</p>



<a name="294717614"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294717614" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294717614">(Aug 22 2022 at 15:56)</a>:</h4>
<p>From: Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;<br>
On 28/08/2017 09:07, Lars Hupel wrote:</p>
<blockquote>
<p>Maybe we should look into which library theories change the most or split <br>
library into multiple sessions.</p>
</blockquote>
<p>Thank you for this constructive suggestion. What would happen if there was an <br>
AFP_Library with only those Library theories that are needed at least twice in <br>
the AFP? I analyzed the sources. Only half the theories in Library are used at <br>
least twice in the AFP. Then I analyzed the last 123 builds on Jenkins: 13 of <br>
them did not involve any theory in AFP_Library and the AFP build would have <br>
completed much more quickly (often in a few minutes rater than 1 hour). There is <br>
an argument here for a dedicated AFP_Library.</p>
<p>Tobias</p>
<blockquote>
<p>Cheers<br>
Lars</p>
<p>On 28 August 2017 08:15:10 CEST, Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt; wrote:</p>
<p>Gerwin wrote:</p>
<p>"Most AFP entries were already based on that, because we’d otherwise be building<br>
    HOL-Library about 50 times or so instead of only once per test. It’s a trade-off."</p>
<p>Well, we would only be building a few popular entries in Library multiple times.<br>
    Indeed it is a trade-off and we win a little(?) by starting from a Library image<br>
    but we lose big time if only a single theory in Library changes. It is a bit<br>
    like amortized complexity: on average, you win, but in real time you may have to<br>
    wait much longer. Since Library changes frequently, I do wonder about this<br>
    trade-off.</p>
<p>Tobias</p>
<p>On 27/08/2017 13:35, Tobias Nipkow wrote:</p>
<p>Hi Makarius,</p>
<p>You have concerted many if not all AFP sessions that use theories from<br>
        Library<br>
        such that they are now based on the Library image. This means that every<br>
        time a<br>
        Library theory changes, sonething like half the AFP needs to be rebuilt<br>
        even<br>
        though only a few of the AFP sessions may import the modified Library<br>
        theory.<br>
        This happens fairly frequently and I wonder what your rational for the<br>
        change was.</p>
<p>Tobias</p>
<p><a href="/user_uploads/14278/4OrLEJqyqV4q9I2ezwhqASah/smime.p7s">smime.p7s</a></p>
</blockquote>



<a name="294717821"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294717821" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294717821">(Aug 22 2022 at 15:57)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
Some more notes on this.</p>
<p>The present reform of session-qualified theory names in Isabelle2017<br>
still allows old-fashioned unqualified imports from existing parent<br>
session images. It eases the upgrade of existing project sources, but it<br>
means that the parent session structure still has an impact on the<br>
theory name space.</p>
<p>Right after the Isabelle2017 release we can get rid of that, and parent<br>
sessions vs. imported sessions (keyword 'sessions' in the ROOT) become<br>
interchangeable -- as far as logical theory names are concerned (not the<br>
time for loading theories).</p>
<p>This opens many possibilities to rearrange things, either statically in<br>
the ROOT files, or dynamically by a smarter version of "isabelle build".<br>
For example, all AFP sessions with &lt; 30s runtime could be built in one<br>
big ML process, for improved parallel performance and to avoid loading<br>
the base session many times.</p>
<p>There are many more possibilities, especially with full timing<br>
information of all sessions, theories, commands available to the build<br>
process.</p>
<p>Makarius</p>



<a name="294717875"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294717875" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294717875">(Aug 22 2022 at 15:57)</a>:</h4>
<p>From: Florian Haftmann &lt;<a href="mailto:florian.haftmann@informatik.tu-muenchen.de">florian.haftmann@informatik.tu-muenchen.de</a>&gt;</p>
<blockquote>
<p>Maybe we should look into which library theories change the most or split library into multiple sessions.</p>
</blockquote>
<p>My personal experience suggests that substantial rebuilds after pull are<br>
seldom triggered by changes to HOL-Library; most times, that is due to<br>
changes to HOL-Main / HOL-Complex theories — however this is not based<br>
on any accountable evidence, so it might indeed be interesting to know<br>
which candidates in HOL-Library have considerable velocity.</p>
<p>In the past, we occasionally split off sessions from HOL-Library<br>
(sometimes also HOL-ex) as separate parts, the latest of these being<br>
HOL-Computation_Algebra.  Though scalability always played a part in the<br>
considerations, we always managed to find a conceptual distinction to<br>
make clear how the contents of the newly established session should look<br>
like.</p>
<p>After a casual look at</p>
<p>$ wc -l src/HOL/Library/*.thy | sort -n</p>
<p>the following rough ideas come to my mind:</p>
<p>a) Shift further material to Computational_Algebra, e. g. Extended* or<br>
material on orders and lattices.</p>
<p>b) Shift material to Datastructures, e. g. RBT*</p>
<p>c) Split off technical »utilities« like Simps_Case_Conv, Pattern_Aliases<br>
and Code_ to  a separate session HOL-Utilities (»tools« is already used<br>
by a different tradition).</p>
<p>Cheers,<br>
    Florian</p>
<p>P. S. Since that is a post-release issue and the original issue not<br>
relevant for users working on stable releases, we should move this<br>
discussion to isabelle-dev.<br>
<a href="/user_uploads/14278/vmgd9wUybA-OBQt3xaIhliMO/signature.asc">signature.asc</a></p>



<a name="294717893"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294717893" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294717893">(Aug 22 2022 at 15:57)</a>:</h4>
<p>From: Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;<br>
As long as this is transparent, you are of course welcome to optimize "isabelle <br>
build" for tasks like the AFP. Everything that involves changes to the AFP needs <br>
to be discussed first.</p>
<p>Tobias<br>
<a href="/user_uploads/14278/uu9__xmXAK4CmHVU1lDOOw5V/smime.p7s">smime.p7s</a></p>



<a name="294717904"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20AFP%20and%20Library/near/294717904" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20AFP.20and.20Library.html#294717904">(Aug 22 2022 at 15:57)</a>:</h4>
<p>From: Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;<br>
On 31/08/2017 13:26, Florian Haftmann wrote:</p>
<blockquote>
<blockquote>
<p>Maybe we should look into which library theories change the most or split library into multiple sessions.</p>
</blockquote>
<p>My personal experience suggests that substantial rebuilds after pull are<br>
seldom triggered by changes to HOL-Library; most times, that is due to<br>
changes to HOL-Main / HOL-Complex theories — however this is not based<br>
on any accountable evidence, so it might indeed be interesting to know<br>
which candidates in HOL-Library have considerable velocity.</p>
</blockquote>
<p>From my analysis of these 123 revisions, 10% of the builds could have been <br>
reduced from 30-60 mins to a few minutes by a less bloated Library. This is <br>
clearly not dramatic but it is helpful.</p>
<blockquote>
<p>In the past, we occasionally split off sessions from HOL-Library<br>
(sometimes also HOL-ex) as separate parts, the latest of these being<br>
HOL-Computation_Algebra.  Though scalability always played a part in the<br>
considerations, we always managed to find a conceptual distinction to<br>
make clear how the contents of the newly established session should look<br>
like.</p>
</blockquote>
<p>I certainly support moving theories out of Library for conceptual reasons, and <br>
it may also have the desired side effect.</p>
<p>Concerning Data_Structures please note that this directory is dedicated to <br>
conceptually clean and simple models of data structures and not to efficient <br>
implementations. Hence it is not the right home for Library/RBT*.</p>
<p>Tobias</p>
<blockquote>
<p>After a casual look at</p>
<p>$ wc -l src/HOL/Library/*.thy | sort -n</p>
<p>the following rough ideas come to my mind:</p>
<p>a) Shift further material to Computational_Algebra, e. g. Extended* or<br>
material on orders and lattices.</p>
<p>b) Shift material to Datastructures, e. g. RBT*</p>
<p>c) Split off technical »utilities« like Simps_Case_Conv, Pattern_Aliases<br>
and Code_ to  a separate session HOL-Utilities (»tools« is already used<br>
by a different tradition).</p>
<p>Cheers,<br>
  Florian</p>
<p>P. S. Since that is a post-release issue and the original issue not<br>
relevant for users working on stable releases, we should move this<br>
discussion to isabelle-dev.</p>
<p><a href="/user_uploads/14278/oPzTdSJDoOpMV4DQ944Eq8ue/smime.p7s">smime.p7s</a></p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 20:30 UTC</p>
</html>