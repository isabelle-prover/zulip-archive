<html>
<head><meta charset="utf-8"><title>[isabelle] Failing afp-2015 build · Archive Mirror: Isabelle Users Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/index.html">Archive Mirror: Isabelle Users Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html">[isabelle] Failing afp-2015 build</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294658692"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294658692" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294658692">(Aug 22 2022 at 11:51)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;<br>
Dear list,</p>
<p>while trying to run some performance tests on potential future Jenkins<br>
servers, I've encountered a  in my opinion  severe problem. The setup is<br>
as follows:</p>
<p>$ isabelle version<br>
Isabelle2015: May 2015</p>
<p>$ uname -a<br>
Linux lars-demon 4.2.3-1-ARCH #1 SMP PREEMPT Sat Oct 3 18:52:50 CEST 2015<br>
x86_64 GNU/Linux</p>
<p>$ hg id # afp-2015 repository<br>
770bf7fe6d2b tip</p>
<p>If I now run the session "ConcurrentGC", this happens:</p>
<p>$ isabelle build -bv -d thys -o threads=1 ConcurrentGC<br>
[...]<br>
ML_PLATFORM="x86-linux"<br>
ML_HOME="/opt/Isabelle2015/contrib/polyml-5.5.2-3/x86-linux"<br>
ML_SYSTEM="polyml-5.5.2"<br>
ML_OPTIONS="-H 500"<br>
[...]<br>
*** A total of 104 subgoals...<br>
*** At command "by" (line 130 of "~/proj/afp-2015/thys/ConcurrentGC/TSO.thy")<br>
Unfinished session(s): ConcurrentGC</p>
<p>Exactly the same error occurs with the following settings:</p>
<p>ML_PLATFORM="x86_64-linux"<br>
ML_HOME="/opt/Isabelle2015/contrib/polyml-5.5.2-3/x86_64-linux"<br>
ML_SYSTEM="polyml-5.5.2"<br>
ML_OPTIONS="-H 2000"</p>
<p>I have managed to reproduce this behaviour on three different machines.<br>
However, now comes the worrying part: If I load the failing theory in<br>
Isabelle/jEdit, it goes through just fine! Same goes for building without<br>
"-o threads=1" *. This is a real problem, because I was actually planning<br>
to run each session of the AFP with "-o threads=1". Can anybody reproduce<br>
this behaviour? I'm scared ...</p>
<p>Best<br>
Lars</p>
<ul>
<li>it's still running on my machine, but the build has progressed well<br>
beyond "TSO"</li>
</ul>



<a name="294658702"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294658702" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294658702">(Aug 22 2022 at 11:51)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;</p>
<blockquote>
<ul>
<li>it's still running on my machine, but the build has progressed well<br>
beyond "TSO"</li>
</ul>
</blockquote>
<p>Update: Build has finished on my quad-core Core i7.</p>
<p>Timing ConcurrentGC (4 threads, 3055.987s elapsed time, 7458.113s cpu<br>
time, 643.593s GC time, factor 2.44)<br>
Finished ConcurrentGC (0:51:48 elapsed time, 2:05:59 cpu time, factor 2.43)<br>
Finished at Wed Nov 11 21:58:23 CET 2015<br>
0:51:52 elapsed time, 2:06:15 cpu time, factor 2.43</p>
<p>It is still running on an 8 core "cloud" machine, but that one has also<br>
progressed beyond "TSO".</p>



<a name="294658758"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294658758" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294658758">(Aug 22 2022 at 11:52)</a>:</h4>
<p>From: Peter Lammich &lt;<a href="mailto:lammich@in.tum.de">lammich@in.tum.de</a>&gt;<br>
We have analysed the problem:<br>
It appears in both, Isabelle2015 and Isabelle 40ca618e1b2d.</p>
<p>The behaviour of PARALLEL_GOALS may differ depending on whether there<br>
is one or more threads. It seems nowhere documented what are the<br>
constraints such that the behaviour for the parallel and sequential case<br>
matches, except a NEWS-file entry from 2011, which talks about no<br>
schematic variables and "uniform" behaviour.</p>
<p>The "vcg_jackhammer" tactic implemented in ConcurrentGC seems to run in<br>
one of the cases with different behaviour, and thus triggers the<br>
observed error.</p>
<p>It is unclear whether the problem lies in the jackhammer-tactic or the<br>
PARALLEL_GOALS combinator. In any case, the current state is very<br>
unfortunate, as proof methods may behave differently depending on the<br>
number of threads. </p>
<p>In my opinion, the PARALLEL_GOALS-tactics should completely hide the<br>
effects of parallelism from the user, even if this means some slowdown<br>
in the sequential case (Note: Removing the optimization for the<br>
sequential case in PARALLEL_GOALS, and using the same map-reduce<br>
approach with retrofitting as in the parallel case, fixes the problem in<br>
ConcurrentGC)</p>



<a name="294658804"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294658804" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294658804">(Aug 22 2022 at 11:52)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
Using the dangerous word "fix" means there is a lack of information what <br>
is really going on.  Maybe the author of the "vcg_jackhammer" proof method <br>
can look again and explain the situation.</p>
<p>Makarius</p>



<a name="294658816"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294658816" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294658816">(Aug 22 2022 at 11:52)</a>:</h4>
<p>From: Peter Lammich &lt;<a href="mailto:lammich@in.tum.de">lammich@in.tum.de</a>&gt;<br>
"Fix" was meant in the sense "make disappear this very instance of the<br>
problem". Actually the described change aligns the behaviour for<br>
threads=1 and threads&gt;1, sacrificing the optimization that is currently<br>
there for threads=1.</p>
<p>However, to general questions remain:</p>
<p>1) Is it intentional/desirable to have the behaviour of PARALLEL_GOALS<br>
depend on the number of threads:<br>
  Pro: This allows the current optimization for threads=1<br>
  Con: This makes debugging of tactics/proofs which use PARALLEL_GOALS<br>
harder, as one has to test for threads=1 and threads&gt;1 separately.</p>
<p>2) Is there any documentation on what are the preconditions of<br>
PARALLEL_GOALS such that it shows no diverging behaviour in the<br>
parallel/sequential case? This information is required by anyone who<br>
wants to use PARALLEL_GOALS in a thread-safe way.</p>



<a name="294658838"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294658838" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294658838">(Aug 22 2022 at 11:52)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;</p>
<blockquote>
<p>Using the dangerous word "fix" means there is a lack of information what<br>
is really going on.  Maybe the author of the "vcg_jackhammer" proof<br>
method can look again and explain the situation.</p>
</blockquote>
<p>Even if the AFP entry gets changed, we have a broader problem here. Let<br>
me explain.</p>
<p>As Peter already said, there is no mention of "PARALLEL_GOALS" (or<br>
related combinators) in the official documentation. The only relevant<br>
mention we found is the following NEWS entry:</p>
<blockquote>
<ul>
<li>Refined PARALLEL_GOALS tactical: degrades gracefully for schematic<br>
goal states; body tactic needs to address all subgoals uniformly.</li>
</ul>
</blockquote>
<p>Additionally, there are only few occurrences in the visible Isabelle<br>
universe: The distribution uses it in "clasimp" and "simp", and there<br>
are only two more occurrences in the AFP which are not derived from what<br>
is used in the distribution ("AWN" and "Slicing") *. Hence, the usual<br>
heuristics of looking for canonical examples in the sources to figure<br>
out how it should be used fails. (Also, both "AWN" and "Slicing" build<br>
fine in single-threaded mode.)</p>
<p>Looking just at the implementation, it becomes obvious that the<br>
sequential case stems from a – what I would call – "performance<br>
optimization"; that is, if there is only one thread, there is no point<br>
in setting up auxiliary goal states, so the inner tactic can proceed<br>
undisturbed.</p>
<p>Now, there may very well be invariants which a tactic should fulfill in<br>
order to make both the sequential and the parallel execution<br>
observationally equivalent. My point is that this invariant – in<br>
contrast to many others – are not checked in this combinator, which<br>
allows for inconsistencies to sneak into the official AFP sources. Even<br>
if the AFP entry gets edited in such a way that the usage of the<br>
"PARALLEL_GOALS" combinator is canonical, there might be future<br>
non-canonical uses which are difficult to detect (needless to say, ML<br>
tactic code – while often being necessary – is hard to understand). In<br>
fact, the are only two ways I can think of: Time-intensive review of ML<br>
code or running entries in both single- and multi-threaded mode.</p>
<p>I'm a fairly young user on the general Isabelle time scale, but as far<br>
as I remember, additional checks have been introduced quite often to<br>
prevent the user from doing things which might "just work" but are not<br>
intended to happen (e.g. context discipline). In my opinion the best way<br>
to proceed is to both edit the AFP entry, and to either remove the<br>
optimization in the combinator or add additional robustness checks. In<br>
the case of the "ParallelGC" session, these two measures are independent<br>
of each other.</p>
<p>Cheers<br>
Lars</p>
<ul>
<li>There is one more occurrence in "Isabelle_Meta_Model", but that seems<br>
like a copy of what happens in the simplifier.</li>
</ul>



<a name="294659202"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294659202" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294659202">(Aug 22 2022 at 11:54)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;<br>
Hello Peter,</p>
<blockquote>
<p>Why would you want that?</p>
</blockquote>
<p>I don't think we want that; I believe it is by accident. From what<br>
you're saying it sounds like your tactic is indeed "uniform", so should<br>
be acceptable for use with PARALLEL_GOALS.</p>
<blockquote>
<p>(What is the point of running single-threaded these days?)</p>
</blockquote>
<p>I only discovered that as part of my investigations into how to reliably<br>
build the AFP. There are essentially two axes for parallelism: Internal<br>
to a session (multi-threaded, e.g. parallel proofs, parallel theories)<br>
and between sessions (multi-process, i.e. independent AFP sessions can<br>
be run in parallel). Gerwin and I suspect that it would be most<br>
efficient to exploit the latter on the cost of the former, since the AFP<br>
dependency graph is quite sparse.</p>
<p>Cheers<br>
Lars</p>



<a name="294659302"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294659302" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294659302">(Aug 22 2022 at 11:55)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On Thu, 12 Nov 2015, Lars Hupel wrote:</p>
<blockquote>
<p>As Peter already said, there is no mention of "PARALLEL_GOALS" (or <br>
related combinators) in the official documentation.</p>
</blockquote>
<p>I was actually under the impression that a small paragraph about that was <br>
already in the relevant manuals, but that is not the case.  It will happen <br>
eventually.  (I am committed to keep the important reference manuals <br>
up-to-date, but the massive amount of material is already a problem; many <br>
people just ignore the manuals, either passively or actively.)</p>
<p>Anyway, official documentation is also the ML source and the cumulative <br>
NEWS file.</p>
<blockquote>
<p>The only relevant mention we found is the following NEWS entry:</p>
<blockquote>
<ul>
<li>Refined PARALLEL_GOALS tactical: degrades gracefully for schematic<br>
goal states; body tactic needs to address all subgoals uniformly.</li>
</ul>
</blockquote>
</blockquote>
<p>Doing an exhaustive hypersearch on NEWS in Isabelle2015 provides the <br>
following bits of information:</p>
<p>Isabelle2009-1 (December 2009)</p>
<p>* PARALLEL_CHOICE and PARALLEL_GOALS provide basic support for<br>
   parallel tactical reasoning.</p>
<p>Isabelle2011-1 (October 2011)</p>
<p>* Refined PARALLEL_GOALS tactical: degrades gracefully for schematic<br>
   goal states; body tactic needs to address all subgoals uniformly.</p>
<p>Isabelle2015 (May 2015)</p>
<p>* Tactical PARALLEL_ALLGOALS is the most common way to refer to<br>
   PARALLEL_GOALS.</p>
<p>This provides a glimpse on the typical bottom-up construction of new <br>
Isabelle concepts.  We start with something we know already (<a href="http://Par_List.map">Par_List.map</a>) <br>
and work our way through further system structures, e.g. tactical <br>
reasoning with goal and subgoal addressing.</p>
<p>You probably know that the Larry-Paulson-goal-state is great in many <br>
respects, but also more concrete than semantically intended.  This means <br>
ML tactics and Isar proof methods need to be "well-behaved" in certain <br>
ways.  This is quite explicitly documented in the "implementation" manual, <br>
but I still see violations routinely in Isabelle applications.  The proof <br>
parallelization occasionally changes the representation of goal states, <br>
and tactic expressions seen in the wild break down.</p>
<p>The present situation seems to be much less spectacular, though.</p>
<p>For the PARALLEL_GOALS, the October 2011 NEWS snipped says "body tactic <br>
needs to address all subgoals uniformly".  This means it needs to ignore <br>
the accidental number of subgoals that it sees, and operate on all <br>
subgoals that happen to be there, e.g. like simp_all.</p>
<p>Since it already turned out a bit impractical to take this extra condition <br>
into account in applications, and all concrete uses were using ALLGOALS, <br>
the May 2015 version formalizes that situation by a new PARALLEL_ALLGOALS <br>
combinator and makes it "the most common way" in the NEWS.</p>
<p>The ConcurrentIMP session was added before the Isabelle2015 release, where <br>
PARALLEL_ALLGOALS was not yet available as canonical shortcut.  Thus it <br>
fell into the gap of the historical confusion of what PARALLEL_GOALS <br>
really means.</p>
<p>So this is just a routine case of updating existing AFP entries. What is <br>
less routine is the total run-time of that session, which makes <br>
maintenance more difficult.  I have already reduced it a lot by using the <br>
newer 'subgoal' Isar command, but that is for the next Isabelle release.</p>
<blockquote>
<ul>
<li>There is one more occurrence in "Isabelle_Meta_Model", but that seems<br>
  like a copy of what happens in the simplifier.</li>
</ul>
</blockquote>
<p>I will standardize all occurrences, but only in afp-devel.</p>
<p>Makarius</p>



<a name="294659318"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294659318" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294659318">(Aug 22 2022 at 11:55)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
The behaviour and the name should fit together. A tactical that is a <br>
parallel version of ALLGOALS should be called like that. If PARALLEL_GOALS <br>
had been like PARALLEL_ALLGOALS from the outset, I would have also used <br>
that name.</p>
<p>Makarius</p>



<a name="294659569"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294659569" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294659569">(Aug 22 2022 at 11:56)</a>:</h4>
<p>From: Peter Gammie &lt;<a href="mailto:peteg42@gmail.com">peteg42@gmail.com</a>&gt;<br>
I’m not doing anything clever here - my use of PARALLEL_GOALS was intended to have the same semantics as ALLGOALS (IIRC - it’s been a while). As far as I’m concerned it’s just an optimisation, albeit one that was somewhat essential to invariant discovery.</p>
<p>The goals produced by vcg_jackhammer should be completely independent (no schematics etc).</p>
<p>I never tested the single-threaded mode, and don’t see the point in it having an observably-distinct (wrt goal states etc.) semantics from the multi-threaded one. Why would you want that? (What is the point of running single-threaded these days?)</p>
<p>Thanks to everyone for the diagnoses.</p>
<p>cheers,<br>
peter (resent at Larry’s request)</p>



<a name="294659608"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294659608" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294659608">(Aug 22 2022 at 11:57)</a>:</h4>
<p>From: Peter Gammie &lt;<a href="mailto:peteg42@gmail.com">peteg42@gmail.com</a>&gt;<br>
On 17 Nov 2015, at 23:03, Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt; wrote:</p>
<blockquote>
<p>The ConcurrentIMP session was added before the Isabelle2015 release, where PARALLEL_ALLGOALS was not yet available as canonical shortcut.  Thus it fell into the gap of the historical confusion of what PARALLEL_GOALS really means.</p>
</blockquote>
<p>When would one wish to use PARALLEL_GOALS now? (Why not just change its behaviour to that of PARALLEL_ALLGOALS?)</p>
<blockquote>
<p>So this is just a routine case of updating existing AFP entries. What is less routine is the total run-time of that session, which makes maintenance more difficult.  I have already reduced it a lot by using the newer 'subgoal' Isar command, but that is for the next Isabelle release.</p>
</blockquote>
<p>Sorry about that.</p>
<p>I had in mind to revisit it now-ish, but you’ve beaten me to it. The idea was to turn vcg_jackhammer into something case-like, so the larger proofs would look like:</p>
<p>proof vcg_jackhammer<br>
  case (statement_label x y z) then show ?thesis<br>
    &lt; existing apply gloop &gt;<br>
…</p>
<p>We talked about this earlier. I now have time to chase up your pointers. I hoped this would yield the kind of parallelism your “subgoal”s do now, with the advantage that it’d be more maintainable. Perhaps it’s a wash at this stage.</p>
<p>thanks,<br>
peter</p>



<a name="294659736"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294659736" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294659736">(Aug 22 2022 at 11:57)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On Tue, 17 Nov 2015, Lars Hupel wrote:</p>
<blockquote>
<blockquote>
<p>(What is the point of running single-threaded these days?)</p>
</blockquote>
<p>I only discovered that as part of my investigations into how to reliably <br>
build the AFP. There are essentially two axes for parallelism: Internal <br>
to a session (multi-threaded, e.g. parallel proofs, parallel theories) <br>
and between sessions (multi-process, i.e. independent AFP sessions can <br>
be run in parallel).</p>
</blockquote>
<p>Sequentialism is indeed a very atypical situation, more than 10 years of <br>
multicore hardware becoming mainstream.</p>
<p>In the various different isatest configurations for main Isabelle (not <br>
AFP) we do indeed test normal situations, like threads=4 or threads=8, <br>
alongside with abnormal ones like threads=1 or skip_proofs=true.</p>
<p>Such tests provide empirical evidence that the "physics" of a <br>
highly-complex parallel ML and proof engine comes out as reliably <br>
"mathematics", i.e. results are determined. Asking for determinism in <br>
every respect is a bit much.</p>
<blockquote>
<p>Gerwin and I suspect that it would be most efficient to exploit the <br>
latter on the cost of the former, since the AFP dependency graph is <br>
quite sparse.</p>
</blockquote>
<p>What always happens in such situations is that the total runtime converges <br>
to the longest sequential task.  That used to be JinjaThreads, now it is <br>
AODV or ConcurrentGC.  These take many hours CPU time.  With a good <br>
multicore machine of 2015, it should be possible to run all of Isabelle + <br>
AFP in approximately 1h elapsed time, maybe even less after some tweaking.</p>
<p>Makarius</p>



<a name="294659966"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294659966" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294659966">(Aug 22 2022 at 11:59)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
The relevant changeset for Isabelle_Meta_Model is AFP/c4abbb09645a, but it <br>
merely conflates proper use of (PARALLEL_GOALS o ALLGOALS) to <br>
PARALLEL_ALLGOALS.</p>
<p>The remaining change for ConcurrentGC is included here -- I leave it to <br>
the author/maintainer to apply it on afp-2015 and/or afp-devel.  (E.g. <br>
with "hg import".)</p>
<p>That is the result of staring a rather long time at not-quite-canonical <br>
tactic definitions, to figure out how subgoal addressing is used. <br>
Non-standard indentation and overlong source lines make it more difficult <br>
to read the text than necessary.</p>
<p>Earlier on this thread, I claimed that there was merely a confusion of <br>
PARALLEL_GOALS vs. the newer PARALLEL_ALLGOALS, but basic goal addressing <br>
without parallelism was already unclear.  Here are relevant paragraphs <br>
from the "implementation" manual:</p>
<p>Operating on a particular subgoal means to replace it by an interval<br>
   of zero or more subgoals in the same place; other subgoals must not<br>
   be affected, apart from instantiating schematic variables ranging<br>
   over the whole goal state.</p>
<p>A common pattern of composing tactics with subgoal addressing is to<br>
   try the first one, and then the second one only if the subgoal has<br>
   not been solved yet.  Special care is required here to avoid bumping<br>
   into unrelated subgoals that happen to come after the original<br>
   subgoal.  Assuming that there is only a single initial subgoal is a<br>
   very common error when implementing tactics!</p>
<p>...</p>
<p>Some of these conditions are checked by higher-level goal<br>
   infrastructure (\secref{sec:struct-goals}); others are not checked<br>
   explicitly, and violating them merely results in ill-behaved tactics<br>
   experienced by the user (e.g.\ tactics that insist in being<br>
   applicable only to singleton goals, or prevent composition via<br>
   standard tacticals such as @{ML REPEAT}).</p>
<p>Testing this minor change required exceedingly long time, just to get 4-5 <br>
attempts work out eventually.</p>
<p>Are there deeper reasons for these proofs to be so slow?  The elapsed time <br>
of ConncurrentIMP is about that of all of the rest of AFP taken together.</p>
<p>As another peepwhole optimization, it should be possible to conflate</p>
<p>apply m1<br>
   apply m2<br>
   done</p>
<p>to</p>
<p>by m1 m2</p>
<p>This is forked in Isabelle/jEdit.  Unlike batch builds, more complex <br>
proofs are still not forked in the Prover IDE after all these years.</p>
<p>Makarius<br>
<a href="/user_uploads/14278/Pi3Z2Wuj0-S92r7ghGFuhZTh/ch">ch</a></p>



<a name="294660104"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294660104" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294660104">(Aug 22 2022 at 11:59)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
(Back to this thread, which is not yet closed in all its sub-threads.)</p>
<p>Using the 'subgoal' command of future Isabelle2016 did indeed make a <br>
significant difference some months ago.  Nonetheless there seems to be <br>
room for more efficiency of the basic proof tools used here.</p>
<p>Just from the English, what does "Perhaps it’s a wash at this stage." <br>
meand?</p>
<p>Makarius</p>



<a name="294660152"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294660152" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294660152">(Aug 22 2022 at 12:00)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On Thu, 19 Nov 2015, Makarius wrote:</p>
<blockquote>
<p>The remaining change for ConcurrentGC is included here -- I leave it to the <br>
author/maintainer to apply it on afp-2015 and/or afp-devel.  (E.g. with "hg <br>
import".)</p>
<p>That is the result of staring a rather long time at not-quite-canonical <br>
tactic definitions, to figure out how subgoal addressing is used.</p>
</blockquote>
<p>That is almost 3 weeks old, and nothing has happened yet.  I am routinely <br>
on afp-devel, but not the official release branches.  Ultimately, it is <br>
the job of the AFP authors to maintain their material.</p>
<blockquote>
<p>Testing this minor change required exceedingly long time, just to get 4-5 <br>
attempts work out eventually.</p>
<p>Are there deeper reasons for these proofs to be so slow?  The elapsed time of <br>
ConncurrentIMP is about that of all of the rest of AFP taken together.</p>
<p>As another peepwhole optimization, it should be possible to conflate</p>
<p>apply m1<br>
  apply m2<br>
  done</p>
<p>to</p>
<p>by m1 m2</p>
<p>This is forked in Isabelle/jEdit.  Unlike batch builds, more complex proofs <br>
are still not forked in the Prover IDE after all these years.</p>
</blockquote>
<p>This is also something that can be easily done to improve the <br>
maintainability of ConcurrentGC.</p>
<p>Makarius<br>
<a href="/user_uploads/14278/zhdgyW6hdQrs7Tz1BAtvWxRf/ch">ch</a></p>



<a name="294660209"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294660209" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294660209">(Aug 22 2022 at 12:00)</a>:</h4>
<p>From: Peter Gammie &lt;<a href="mailto:peteg42@gmail.com">peteg42@gmail.com</a>&gt;<br>
On 7 Dec 2015, at 22:19, Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt; wrote:</p>
<blockquote>
<p>That is almost 3 weeks old, and nothing has happened yet.  I am routinely on afp-devel, but not the official release branches. Ultimately, it is the job of the AFP authors to maintain their material.</p>
</blockquote>
<p>Makarius, I am on holidays presently and will not get to this until February 2016 or later.</p>
<p>You have previously pushed substantial changes to ConcurrentGC without discussing them with me at all, and I don’t see why this should be any different. If it is important to you, go ahead and commit it. It should be clear that I simply want those tactics to work - I have no deep insight into the Isabelle tactic API, for otherwise I would have got it right before now. If it were my project, I would take this as an opportunity to make the Isabelle tactic API more robust, so people like me don’t cause maintenance headaches for people like you.</p>
<p>As for runtimes: Florian’s email on isabelle-dev 2015-11-26 (why is this thread I’m responding to on isabelle-users? Aren’t we talking about the development version of the AFP for the upcoming Isabelle2016 release? <em>brain explodes</em>):</p>
<blockquote>
<p>For the record:</p>
<blockquote>
<p>Running on host lxbroy10<br>
isabelle: fc53fbf9fe01 tip<br>
afp: 835c7e115feb tip<br>
Running ConcurrentGC ...<br>
Finished ConcurrentGC (1:08:48 elapsed time, 5:15:14 cpu time, factor 4.58)<br>
1:21:59 elapsed time, 5:53:13 cpu time, factor 4.30</p>
</blockquote>
</blockquote>
<p>Five hours of CPU seems excessive. Is this machine ancient? I don’t remember it being this bad when I submitted it to the AFP.</p>
<blockquote>
<p>Just from the English, what does “Perhaps it’s a wash at this stage." meand?</p>
</blockquote>
<p>As for English idioms, I would start by asking Google; it seems the phrase “it’s a wash” has a few interpretations. I humbly suggest you avoid using the passive voice as it tends to come across as aggressive. In many cases it distracts me and other subscribers from the often valid points you are making.</p>
<p>thanks,<br>
peter</p>



<a name="294660219"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294660219" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294660219">(Aug 22 2022 at 12:00)</a>:</h4>
<p>From: Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;<br>
On 08/12/2015 00:15, Jeremy Dawson wrote:</p>
<blockquote>
<p>On 08/12/15 02:19, Makarius wrote:</p>
<blockquote>
<p>Ultimately, it is the job of the AFP authors to maintain their material.<br>
</p>
</blockquote>
</blockquote>
<p>That is indeed what the AFP web pages say.</p>
<blockquote>
<p>Huh?  When I was urged to convert all my proofs to Isar so that they could go<br>
into the AFP, I was told</p>
<p>(quote)<br>
Once your theories are in the AFP, every developer who makes a<br>
change that breaks any of the theories in the AFP (or the Isabelle<br>
distribution) is responsible for fixing it, which is usually not too<br>
difficult, since the developer knows what kind of changes he has made.<br>
(end quote)</p>
</blockquote>
<p>That is the practice in 99% of the cases.</p>
<p>Tobias<br>
<a href="/user_uploads/14278/aVTvDQz-d3ylgbwyWJt5LeFn/smime.p7s">smime.p7s</a></p>



<a name="294660310"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294660310" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294660310">(Aug 22 2022 at 12:00)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
On Tue, 8 Dec 2015, Peter Gammie wrote:</p>
<blockquote>
<p>You have previously pushed substantial changes to ConcurrentGC without <br>
discussing them with me at all, and I don’t see why this should be any <br>
different. If it is important to you, go ahead and commit it.</p>
</blockquote>
<p>I have no problems to push that on afp-devel, but thus it won't be on <br>
afp-2015.  The start of the thread (and its subject line) is about <br>
afp-2015: Lars Hupel reported problems that are relevant for that release <br>
branch, for continuous testing in sequential mode.</p>
<p>Isabelle and AFP are not just a sink for material.  It is continuously <br>
crunched and continuosly improved, especially for performance and <br>
robustness.</p>
<blockquote>
<p>It should be clear that I simply want those tactics to work - I have no <br>
deep insight into the Isabelle tactic API, for otherwise I would have <br>
got it right before now. If it were my project, I would take this as an <br>
opportunity to make the Isabelle tactic API more robust, so people like <br>
me don’t cause maintenance headaches for people like you.</p>
</blockquote>
<p>The tactic API is from 1989 and cannot be changed without changing almost <br>
everything of the Paulson goal state representation (which was a big asset <br>
in its time, and still has many benefits that other ITP systems lack).</p>
<p>The "implementation" manual is quite explicit about what the ML type <br>
tactic (and Proof.method) mean semantically.  It is OK to ignore manuals <br>
in the first round.  It is not OK to complain about the existence of <br>
manuals.</p>
<blockquote>
<blockquote>
<blockquote>
<p>Running on host lxbroy10<br>
isabelle: fc53fbf9fe01 tip<br>
afp: 835c7e115feb tip<br>
Running ConcurrentGC ...<br>
Finished ConcurrentGC (1:08:48 elapsed time, 5:15:14 cpu time, factor 4.58)<br>
1:21:59 elapsed time, 5:53:13 cpu time, factor 4.30</p>
</blockquote>
</blockquote>
<p>Five hours of CPU seems excessive. Is this machine ancient? I don’t <br>
remember it being this bad when I submitted it to the AFP.</p>
</blockquote>
<p>The machine is ancient, but ConcurrentGC has always been that slow. <br>
Before I made some changes with 'subgoal' it was even slower -- approx. by <br>
a factor 1.5.</p>
<blockquote>
<blockquote>
<p>Just from the English, what does “Perhaps it’s a wash at this stage." <br>
meand?</p>
</blockquote>
<p>As for English idioms, I would start by asking Google; it seems the <br>
phrase “it’s a wash” has a few interpretations. I humbly suggest you <br>
avoid using the passive voice as it tends to come across as aggressive. <br>
In many cases it distracts me and other subscribers from the often valid <br>
points you are making.</p>
</blockquote>
<p>Sorry, I don't know English slang, only international scientific pidgin.</p>
<p>So far the agressions has been mostly on the side of the massive <br>
ConcurrentGC session, which has sucked up quite a lot of resources of <br>
everybody involved in ongoing Isabelle + AFP maintenance.</p>
<p>It is still unclear to me, why these proofs are so slow.  You as the <br>
author should know.</p>
<p>Makarius</p>



<a name="294660331"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294660331" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294660331">(Aug 22 2022 at 12:01)</a>:</h4>
<p>From: Gerwin Klein &lt;<a href="mailto:Gerwin.Klein@nicta.com.au">Gerwin.Klein@nicta.com.au</a>&gt;<br>
Let’s make the change in afp-devel and see how much improvement we get over time. It won’t be visible until the next release, but afp-devel is the side that is run more often in any case.</p>
<p>ch.txt was meant to apply to afp-devel, correct? I can have a look at that.</p>
<p>Cheers,<br>
Gerwin</p>
<p>ps: “it’s a wash” means “comes out to roughly the same thing"</p>
<hr>
<p>The information in this e-mail may be confidential and subject to legal professional privilege and/or copyright. National ICT Australia Limited accepts no liability for any damage caused by this email or its attachments.</p>



<a name="294660344"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Failing%20afp-2015%20build/near/294660344" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Failing.20afp-2015.20build.html#294660344">(Aug 22 2022 at 12:01)</a>:</h4>
<p>From: Makarius &lt;<a href="mailto:makarius@sketis.net">makarius@sketis.net</a>&gt;<br>
Yes.</p>
<p>Makarius</p>



<hr><p>Last updated: Feb 22 2026 at 20:30 UTC</p>
</html>