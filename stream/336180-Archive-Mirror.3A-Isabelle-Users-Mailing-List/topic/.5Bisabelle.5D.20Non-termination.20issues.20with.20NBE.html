<html>
<head><meta charset="utf-8"><title>[isabelle] Non-termination issues with NBE · Archive Mirror: Isabelle Users Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/index.html">Archive Mirror: Isabelle Users Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Non-termination.20issues.20with.20NBE.html">[isabelle] Non-termination issues with NBE</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294711863"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Non-termination%20issues%20with%20NBE/near/294711863" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Non-termination.20issues.20with.20NBE.html#294711863">(Aug 22 2022 at 15:34)</a>:</h4>
<p>From: Andreas Lochbihler &lt;<a href="mailto:andreas.lochbihler@inf.ethz.ch">andreas.lochbihler@inf.ethz.ch</a>&gt;<br>
Dear all,</p>
<p>I've read in the paper on Isabelle's normalisation-by-evaluation mechanism (Aehlig, <br>
Haftmann, Nipkow, JFP 22(1), 2010) that it is supposed to delay the evaluation in the <br>
branches of case expressions (Section 5.2) until it is clear which case to evaluate. <br>
Unfortunately, this seems to be broken in some cases. Here's a contrived example:</p>
<p>definition silly :: "nat =&gt; nat" where "silly _ = 0"<br>
lemma [code]: "silly n = id (case n of 0 =&gt; silly (Suc 0) | Suc n =&gt; silly n)" sorry<br>
value [nbe] "silly n" (* does not terminate *)</p>
<p>As the argument to silly is a variable, I would have expected that this returns "silly n" <br>
or maybe "case n of 0 =&gt; silly (Suc n) | Suc n =&gt; silly n", but the call to value loops. <br>
Interestingly, when I drop the "id" in the above code equation, then NBE does terminate <br>
with the expected result. Is this intended? Can I somehow enforce that the branches of a <br>
case are evaluated only after it is clear which branch to take?</p>
<p>Best,<br>
Andreas</p>



<a name="294711959"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Non-termination%20issues%20with%20NBE/near/294711959" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Non-termination.20issues.20with.20NBE.html#294711959">(Aug 22 2022 at 15:34)</a>:</h4>
<p>From: Florian Haftmann &lt;<a href="mailto:florian.haftmann@informatik.tu-muenchen.de">florian.haftmann@informatik.tu-muenchen.de</a>&gt;<br>
Hi Andreas,</p>
<p>you can inspect code generated by NBE using</p>
<p>declare [[nbe_trace]]</p>
<p>Note that this is extremely arcane to study, though.</p>
<p>Concerning your particular observation: case matches are treated<br>
differently a) on top level of rhs b) inside a nested term expression.</p>
<p>a) is implemented the same way as pattern match failure on LHS: a failed<br>
pattern match advances to the next code equation.  Using the same<br>
operational semantics in case b) would require a more sophisticated code<br>
generation, either involving exceptions or some kind of option monad,<br>
which we have been reluctant to undertake; instead, the case combinator<br>
is left as it is, but the other terms of the case expression are normalized.</p>
<p>Hope this helps,<br>
    Florian<br>
<a href="/user_uploads/14278/E9xoTf0EWCeI2-iWR1bstCWN/signature.asc">signature.asc</a></p>



<a name="294712013"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20Non-termination%20issues%20with%20NBE/near/294712013" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20Non-termination.20issues.20with.20NBE.html#294712013">(Aug 22 2022 at 15:34)</a>:</h4>
<p>From: Andreas Lochbihler &lt;<a href="mailto:andreas.lochbihler@inf.ethz.ch">andreas.lochbihler@inf.ethz.ch</a>&gt;<br>
Hi Florian,</p>
<p>Thanks for the quick answer. Looking at the code, I can see the difference in treatment.</p>
<p>I had hoped that there was some clever trick to delay the normalisation of the branches in <br>
the code and that I might be able to use the same trick to stop NBE from expanding <br>
corecursive definitions for ever. But as is, it seems impossible to get lazy evaluation <br>
with NBE. :-(</p>
<p>Best,<br>
Andreas</p>



<hr><p>Last updated: Nov 01 2025 at 16:22 UTC</p>
</html>