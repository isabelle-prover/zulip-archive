<html>
<head><meta charset="utf-8"><title>[isabelle] size setup for HOL/Library/Finite_Map (fmap) · Archive Mirror: Isabelle Users Mailing List · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/index.html">Archive Mirror: Isabelle Users Mailing List</a></h2>
<h3>Topic: <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html">[isabelle] size setup for HOL/Library/Finite_Map (fmap)</a></h3>

<hr>

<base href="https://isabelle.zulipchat.com/">

<head><link href="http://isabelle.systems/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294714852"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294714852" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294714852">(Aug 22 2022 at 15:50)</a>:</h4>
<p>From: Peter Gammie &lt;<a href="mailto:peteg42@gmail.com">peteg42@gmail.com</a>&gt;<br>
Dear BNF experts,</p>
<p>The <code>size</code> function for <code>fmap</code> in HOL/Library/Finite_Map in Isabelle2016-1 seems sub-optimal: it appears to ignore the sizes of the things in the map.</p>
<p>I tried implementing this using the approach taken in FSet and Multiset, but the <code>fmap</code> constructor is binary and I’m not sure what shape the theorems should be (specifically the final one that composes size functions somehow).</p>
<p>Thanks!</p>
<p>cheers,<br>
peter</p>



<a name="294714862"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294714862" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294714862">(Aug 22 2022 at 15:50)</a>:</h4>
<p>From: Andreas Lochbihler &lt;<a href="mailto:andreas.lochbihler@inf.ethz.ch">andreas.lochbihler@inf.ethz.ch</a>&gt;<br>
Hi Pete,</p>
<p>You need a function size_fmap that takes a size function for every type argument, even the <br>
dead ones. So it should have the type</p>
<p>('a =&gt; nat) =&gt; ('b =&gt; nat) =&gt; ('a, 'b) fmap =&gt; nat</p>
<p>Typically, the instantiation for the type class then puts "%_. 0" for the arguments.</p>
<p>Hope this helps,<br>
Andreas</p>



<a name="294714904"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294714904" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294714904">(Aug 22 2022 at 15:50)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;<br>
This is an oversight – I'll try to add this to the theory over the next<br>
couple of days.</p>
<p>Cheers<br>
Lars</p>



<a name="294714923"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294714923" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294714923">(Aug 22 2022 at 15:50)</a>:</h4>
<p>From: Peter Gammie &lt;<a href="mailto:peteg42@gmail.com">peteg42@gmail.com</a>&gt;<br>
Great, thanks!</p>
<p>cheers,<br>
peter</p>



<a name="294714987"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294714987" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294714987">(Aug 22 2022 at 15:51)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;</p>
<blockquote>
<p>This is an oversight – I'll try to add this to the theory over the next<br>
couple of days.</p>
</blockquote>
<p>See now &lt;<a href="http://isabelle.in.tum.de/repos/isabelle/rev/4d2ce596f505">http://isabelle.in.tum.de/repos/isabelle/rev/4d2ce596f505</a>&gt;.</p>
<p>Peter, please try it out and tell me if it works for you.</p>
<p>Cheers<br>
Lars</p>



<a name="294715034"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294715034" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294715034">(Aug 22 2022 at 15:51)</a>:</h4>
<p>From: Peter Gammie &lt;<a href="mailto:peteg42@gmail.com">peteg42@gmail.com</a>&gt;<br>
Lars, Andreas:</p>
<p>Thanks Lars. I backported it to Isabelle2016-1 and indeed my termination proof now goes through.</p>
<p>Another question for you and Andreas: what is the substantive difference in intent between Finite_Map and FinFun? I used Finite_Map as I needed the BNF setup, but I reached for FinFun first as I knew it was there. In the fullness of time, could they perhaps be merged?</p>
<p>And another, but perhaps more directly for the BNF people: I’ve been tripped up on products uniformly having a constant size a few times now. Here’s a quick theorem search:</p>
<p>Basic_BNF_LFPs.prod.size(2): size (?x1.0, ?x2.0) = Suc 0</p>
<p>Could it too be made more useful by returning the sum of the sizes of its arguments?</p>
<p>(These arose in termination arguments, and the fun package seems to avoid using size on products. I wonder if such a change would impact it.)</p>
<p>cheers,<br>
peter</p>
<p>—<br>
<a href="http://peteg.org/">http://peteg.org/</a></p>



<a name="294715088"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294715088" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294715088">(Aug 22 2022 at 15:51)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;</p>
<blockquote>
<p>Another question for you and Andreas: what is the substantive difference in intent between Finite_Map and FinFun? I used Finite_Map as I needed the BNF setup, but I reached for FinFun first as I knew it was there. In the fullness of time, could they perhaps be merged?</p>
</blockquote>
<p>Here's a mailing list thread on that issue:<br>
&lt;<a href="https://lists.cam.ac.uk/pipermail/cl-isabelle-users/2016-September/msg00015.html">https://lists.cam.ac.uk/pipermail/cl-isabelle-users/2016-September/msg00015.html</a>&gt;.</p>
<blockquote>
<p>And another, but perhaps more directly for the BNF people: I’ve been tripped up on products uniformly having a constant size a few times now. Here’s a quick theorem search:</p>
<p>Basic_BNF_LFPs.prod.size(2): size (?x1.0, ?x2.0) = Suc 0</p>
<p>Could it too be made more useful by returning the sum of the sizes of its arguments?</p>
</blockquote>
<p>There is such a function: "size_prod". However, you have to tell the<br>
function package about it.</p>
<blockquote>
<p>(These arose in termination arguments, and the fun package seems to avoid using size on products. I wonder if such a change would impact it.)</p>
</blockquote>
<p>Here's a contrived example:</p>
<p>fun contrived :: "('a list × 'a list) ⇒ ('a list × 'a list)" where<br>
"contrived (xs, y1 # y2 # ys) = contrived (y1 # xs, ys)" |<br>
"contrived (x1 # x2 # xs, ys) = contrived (xs, x1 # ys)" |<br>
"contrived _ = ([], [])"</p>
<p>By default, the function package won't be able to derive a termination<br>
measure for this. But you can add the following before the definition:</p>
<p>lemma [measure_function]: "is_measure (size_prod size size)"<br>
by (rule is_measure.intros)</p>
<p>There's probably a good reason why this doesn't happen by default.<br>
(Possibly time complexity of the termination prover.) If this thing<br>
keeps happening to you (or you need nesting), try this:</p>
<p>lemma [measure_function]: "is_measure f ⟹ is_measure g ⟹ is_measure<br>
(size_prod f g)"<br>
by (rule is_measure.intros)</p>
<p>This might mess up things elsewhere though, so try it at your own risk.</p>
<p>Cheers<br>
Lars</p>



<a name="294715109"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294715109" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294715109">(Aug 22 2022 at 15:51)</a>:</h4>
<p>From: Peter Gammie &lt;<a href="mailto:peteg42@gmail.com">peteg42@gmail.com</a>&gt;<br>
Lars,</p>
<p>Thanks for the pointers. I don’t recall seeing the stuff you mentioned about [measure_function] being mentioned in the <code>functions</code> manual; perhaps it could be added?</p>
<p>cheers,<br>
peter</p>



<a name="294715124"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294715124" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294715124">(Aug 22 2022 at 15:51)</a>:</h4>
<p>From: Lars Hupel &lt;<a href="mailto:hupel@in.tum.de">hupel@in.tum.de</a>&gt;</p>
<blockquote>
<p>Thanks for the pointers. I don’t recall seeing the stuff you mentioned about [measure_function] being mentioned in the <code>functions</code> manual; perhaps it could be added?</p>
</blockquote>
<p>Possibly. Though I'll have to defer to someone who actually understands<br>
the implications of declaring [measure_functions], in particular the<br>
parametrized variants.</p>
<p>Cheers<br>
Lars</p>



<a name="294715196"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294715196" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294715196">(Aug 22 2022 at 15:52)</a>:</h4>
<p>From: Tobias Nipkow &lt;<a href="mailto:nipkow@in.tum.de">nipkow@in.tum.de</a>&gt;<br>
I learned about</p>
<p>lemma [measure_function]: "is_measure f ⟹ is_measure g ⟹ is_measure (size_prod f g)"<br>
by (rule is_measure.intros)</p>
<p>from Peter Lammich who probably uses it more often. He may have some insight as <br>
to the dangers of using this by default.</p>
<p>Not that the recursive function need not be tupled for this to help because <br>
internally the arguments are tupled anyway.</p>
<p>It would indeed be nice if this were mention in the "function manual". In case <br>
somebody feel sufficiently au fait with this feature ...</p>
<p>Tobias<br>
<a href="/user_uploads/14278/WuasevzjoeeOCIJFyApCiXMh/smime.p7s">smime.p7s</a></p>



<a name="294715218"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294715218" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294715218">(Aug 22 2022 at 15:52)</a>:</h4>
<p>From: Peter Lammich &lt;<a href="mailto:lammich@in.tum.de">lammich@in.tum.de</a>&gt;<br>
On Di, 2017-08-15 at 12:14 +0200, Tobias Nipkow wrote:</p>
<blockquote>
<p>I learned about</p>
<p>lemma [measure_function]: "is_measure f ⟹ is_measure g ⟹ is_measure<br>
(size_prod f g)"<br>
by (rule is_measure.intros)</p>
<p>from Peter Lammich who probably uses it more often. He may have some<br>
insight as <br>
to the dangers of using this by default.</p>
</blockquote>
<p>I have not used this very often, too. Only for small isolated examples,<br>
but not in the basis of some big developments.</p>
<p>Nevertheless, I would be curious what would happen if one adds this<br>
lemma by default (e.g. to Main)</p>



<a name="294717709"></a>
<h4><a href="https://isabelle.zulipchat.com/#narrow/stream/336180-Archive%20Mirror%3A%20Isabelle%20Users%20Mailing%20List/topic/%5Bisabelle%5D%20size%20setup%20for%20HOL/Library/Finite_Map%20%28fmap%29/near/294717709" class="zl"><img src="http://isabelle.systems/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Email Gateway <a href="http://isabelle.systems/zulip-archive/stream/336180-Archive-Mirror.3A-Isabelle-Users-Mailing-List/topic/.5Bisabelle.5D.20size.20setup.20for.20HOL.2FLibrary.2FFinite_Map.20.28fmap.29.html#294717709">(Aug 22 2022 at 15:57)</a>:</h4>
<p>From: Andreas Lochbihler &lt;<a href="mailto:andreas.lochbihler@inf.ethz.ch">andreas.lochbihler@inf.ethz.ch</a>&gt;<br>
Hi Peter and Peter,</p>
<p>The termination proof methods (lexicographic_order and size_change) use the <br>
[measure_function] theorems to generate all candidate functions in a Prolog style. If this <br>
rule for size_prod is added globally, then these methods will try many more candidates for <br>
functions which use pairs. In detail, every tuple argument gets two changes, namely with <br>
"size" and with "size_prod ... ...". In case of nested tuples, this lead to quadratically <br>
many candidates. Accordingly, the matrix output by a failing lexicographic order may <br>
become harder to read because there are more columns and more failed goals.</p>
<p>My feeling would be that it would not make a big difference for most function definitions, <br>
but some could experience a significant slow-down. AFAIK, the size plugin of the datatype <br>
package does not generate these [measure_function] theorems for the size_F functions, <br>
either, probably for the same reason.</p>
<p>Andreas</p>



<hr><p>Last updated: Feb 22 2026 at 20:30 UTC</p>
</html>