[
    {
        "content": "<p>Hi. I've got two locales <code>A</code> and <code>B</code>. Every instance of <code>B</code> yields various instances of  <code>A</code>, defined via <code>interpretation</code> within the context of <code>B</code>. Later, I instantiate <code>B</code> using <code>global_interpretation</code>, naming a constant from <code>A</code> inherited in the context of <code>B</code>. However, code extraction fails for that constant. Fiddling a bit, I found a solution using <code>code_unfold</code>, but I don't know what I'm doing. So, my questions are: (a) Why is this not handled by <code>global_interpretation</code> already? (b) Why do I need to use <code>code_unfold</code> rather than <code>code</code>?</p>\n<p>Here's a minimal example (with just one interpretation of <code>A</code> within <code>B</code>, for simplicity; I only highlighted this to explain why I'm not using <code>sublocale</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Isabelle\"><pre><span></span><code><span class=\"k\">theory</span><span class=\"w\"> </span><span class=\"n\">Scratch</span>\n<span class=\"kp\">imports</span><span class=\"w\"> </span><span class=\"n\">Main</span>\n<span class=\"k\">begin</span>\n\n<span class=\"k\">locale</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">  </span><span class=\"kp\">fixes</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"s\">‹'a::ab_semigroup_add ⇒ 'a›</span>\n<span class=\"w\">  </span><span class=\"kp\">assumes</span><span class=\"w\"> </span><span class=\"n\">a_linear</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s\">‹⋀x y. a (x+y) = a x + a y›</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">definition</span><span class=\"w\"> </span><span class=\"s\">\"a_a\"</span><span class=\"w\"> </span><span class=\"kp\">where</span><span class=\"w\"> </span><span class=\"s\">‹a_a ≡ a ∘ a›</span>\n<span class=\"k\">end</span>\n\n<span class=\"kt\">thm</span><span class=\"w\"> </span><span class=\"n\">A.a_a_def</span>\n\n<span class=\"k\">locale</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">  </span><span class=\"kp\">fixes</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"s\">‹'a::ab_semigroup_add ⇒ 'a›</span>\n<span class=\"w\">  </span><span class=\"kp\">assumes</span><span class=\"w\"> </span><span class=\"n\">b_linear</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s\">‹⋀x y. b (x+y) = b x + b y›</span>\n\n<span class=\"k\">context</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"k\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">definition</span><span class=\"w\"> </span><span class=\"s\">‹b_a ≡ λx. (b x) + (b x)›</span>\n<span class=\"w\">  </span><span class=\"kn\">interpretation</span><span class=\"w\"> </span><span class=\"n\">B_A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">b_a</span>\n<span class=\"w\">    </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A_def</span><span class=\"w\"> </span><span class=\"n\">B.b_a_def</span><span class=\"w\"> </span><span class=\"n\">B.b_linear</span><span class=\"w\"> </span><span class=\"n\">B_axioms</span>\n<span class=\"w\">      </span><span class=\"n\">ab_semigroup_add_class.add_ac</span><span class=\"o\">(</span><span class=\"n\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">add.left_commute</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">lemmas</span><span class=\"w\"> </span><span class=\"n\">B_A_axioms</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">B_A.A_axioms</span>\n<span class=\"w\">  </span><span class=\"k\">definition</span><span class=\"w\"> </span><span class=\"s\">‹b_a_a ≡ B_A.a_a›</span>\n<span class=\"k\">end</span>\n\n<span class=\"n\">global_interpretation</span><span class=\"w\"> </span><span class=\"n\">IB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"s\">‹λ(x::nat). 2*x›</span>\n<span class=\"w\">  </span><span class=\"kp\">defines</span><span class=\"w\"> </span><span class=\"n\">b_a_export</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">‹IB.b_a›</span>\n<span class=\"w\">      </span><span class=\"kp\">and</span><span class=\"w\"> </span><span class=\"n\">a_a_export</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">‹IB.b_a_a›</span>\n<span class=\"w\">  </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B_def</span><span class=\"o\">)</span>\n\n<span class=\"n\">―‹No</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">equations</span><span class=\"w\"> </span><span class=\"kp\">for</span><span class=\"w\"> </span><span class=\"n\">▩‹A.a_a››</span>\n<span class=\"k\">export_code</span>\n<span class=\"w\">  </span><span class=\"n\">a_a_export</span>\n<span class=\"w\">  </span><span class=\"kp\">in</span><span class=\"w\"> </span><span class=\"n\">SML</span>\n\n<span class=\"n\">―‹▩‹Partially</span><span class=\"w\"> </span><span class=\"n\">applied</span><span class=\"w\"> </span><span class=\"kp\">constant</span><span class=\"w\"> </span><span class=\"s\">\"Scratch.b_a_export\"</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">equation</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kp\">in</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"o\">:</span>\n<span class=\"n\">A.a_a</span><span class=\"w\"> </span><span class=\"n\">b_a_export</span><span class=\"w\"> </span><span class=\"n\">≡</span><span class=\"w\"> </span><span class=\"n\">b_a_export</span><span class=\"w\"> </span><span class=\"n\">∘</span><span class=\"w\"> </span><span class=\"n\">b_a_export››</span>\n<span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">A.a_a_def</span><span class=\"o\">[</span><span class=\"n\">OF</span><span class=\"w\"> </span><span class=\"n\">IB.B_A_axioms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">]</span>\n\n<span class=\"k\">export_code</span>\n<span class=\"w\">  </span><span class=\"n\">a_a_export</span>\n<span class=\"w\">  </span><span class=\"kp\">in</span><span class=\"w\"> </span><span class=\"n\">SML</span>\n\n<span class=\"n\">―‹Finally</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">works</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">don't</span><span class=\"w\"> </span><span class=\"n\">know</span><span class=\"w\"> </span><span class=\"n\">why.</span><span class=\"w\"> </span><span class=\"n\">Why</span><span class=\"w\"> </span><span class=\"n\">▩‹code_unfold›</span><span class=\"w\"> </span><span class=\"n\">rather</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">▩‹code›</span><span class=\"o\">?</span>\n<span class=\"w\">  </span><span class=\"n\">Why</span><span class=\"w\"> </span><span class=\"kp\">is</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">taken</span><span class=\"w\"> </span><span class=\"n\">care</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">▩‹global_interpretation›</span><span class=\"o\">?</span><span class=\"n\">›</span>\n<span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">A.a_a_def</span><span class=\"o\">[</span><span class=\"n\">OF</span><span class=\"w\"> </span><span class=\"n\">IB.B_A_axioms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">code_unfold</span><span class=\"o\">]</span>\n\n<span class=\"k\">export_code</span>\n<span class=\"w\">  </span><span class=\"n\">a_a_export</span>\n<span class=\"w\">  </span><span class=\"kp\">in</span><span class=\"w\"> </span><span class=\"n\">SML</span>\n\n<span class=\"k\">end</span>\n</code></pre></div>",
        "id": 387617221,
        "sender_full_name": "Hanno Becker",
        "timestamp": 1693209079
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"570503\">@Hanno Becker</span>,</p>\n<p>I just came across this old thread and wanted to ask whether you ever found an answer? I currently struggle with a similar setup (or at least the same warnings and errors <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span>) and would also like to understand what is going on.</p>\n<p>Regarding partially applied constants, I found <a href=\"https://stackoverflow.com/questions/52685662/how-to-fix-partially-applied-constant-on-left-hand-side-of-code-equation\">this question on Stack Overflow</a>. I do get the answer by René Thiemann, yet do not know how to get a non-specific code equation when there are assumptions in the locale.</p>\n<p>Also, since I'm trying to export code for  a recursive function, using <code>code_unfold</code> is not an option – <code>export_code</code> gets stuck in an endless loop.</p>\n<p>Any suggestions are highly appreciated :)</p>",
        "id": 567999506,
        "sender_full_name": "Alexandra Graß",
        "timestamp": 1768400854
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"604376\">@Alexandra Graß</span>!</p>\n<p>This issue is still open, and there is an old report on it on the Isabelle mailing list: <a href=\"https://lists.cam.ac.uk/sympa/arc/cl-isabelle-users/2024-01/msg00079.html\">https://lists.cam.ac.uk/sympa/arc/cl-isabelle-users/2024-01/msg00079.html</a></p>\n<p>I think this is a bug in the constant folding in the context of <code>global_interpretation</code> + <code>sublocale/interpretation</code>.</p>\n<p>You can manually do the code equation extraction after the <code>global_interpretation</code>, but it is rather cumbersome. In the above example:</p>\n<div class=\"codehilite\" data-code-language=\"Isabelle\"><pre><span></span><code><span class=\"c\">(* GOOD: b_a_export ≡ λx. 2 * x + 2 * x *)</span>\n<span class=\"kt\">thm</span><span class=\"w\"> </span><span class=\"n\">IB.b_a_def</span>\n\n<span class=\"c\">(* BAD: a_a_export ≡ A.a_a b_a_export *)</span>\n<span class=\"c\">(* A.a_a b_a_export has not been unfolded. *)</span>\n<span class=\"kt\">thm</span><span class=\"w\"> </span><span class=\"n\">IB.b_a_a_def</span>\n\n<span class=\"c\">(* You need to manually unfold A.a_a, refering to the proof of A in B,</span>\n<span class=\"c\">   and then register it as a code equation *)</span>\n<span class=\"k\">declare</span><span class=\"w\"> </span><span class=\"n\">IB.b_a_a_def</span><span class=\"o\">[</span><span class=\"n\">simplified</span><span class=\"w\"> </span><span class=\"n\">A.a_a_def</span><span class=\"o\">[</span><span class=\"n\">OF</span><span class=\"w\"> </span><span class=\"n\">IB.B_A_axioms</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">]</span>\n\n<span class=\"c\">(* Hooray! *)</span>\n<span class=\"k\">export_code</span><span class=\"w\"> </span><span class=\"n\">b_a_export</span><span class=\"w\"> </span><span class=\"kp\">in</span><span class=\"w\"> </span><span class=\"n\">SML</span>\n</code></pre></div>",
        "id": 568011963,
        "sender_full_name": "Hanno Becker",
        "timestamp": 1768403867
    },
    {
        "content": "<p>Thank you for replying so quickly! Still didn't succeed in setting up everything s.t. there is no warnings when declaring the code equations, even with your helpful suggestions above (but again, slightly different setup). I'm currently trying to construct a MWE and will come back to this thread as soon as that exists :)</p>",
        "id": 568387322,
        "sender_full_name": "Alexandra Graß",
        "timestamp": 1768554565
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"604376\">@Alexandra Graß</span> Sure, happy to take a look once you have an MWE <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 568394803,
        "sender_full_name": "Hanno Becker",
        "timestamp": 1768557089
    },
    {
        "content": "<p>My MWE is now a write-up of the painful journey into the depths of Isabelle's code generation <span aria-label=\"smiling face\" class=\"emoji emoji-263a\" role=\"img\" title=\"smiling face\">:smiling_face:</span></p>\n<p>Characteristics of my problem were:</p>\n<ul>\n<li>locales with assumptions</li>\n<li>supplying code equations for mutually recursive, potentially non-terminating functions</li>\n<li>the locales come with different sort constrains</li>\n</ul>\n<p><strong>Tl;dr:</strong> <a href=\"https://isabelle.in.tum.de/doc/codegen.pdf#subsection.9.5\">RTFM</a></p>\n<p>Hope my write-up will help some future confused code exporter! <span aria-label=\"map\" class=\"emoji emoji-1f5fa\" role=\"img\" title=\"map\">:map:</span></p>\n<p><a href=\"/user_uploads/14278/pysQc5YI4A-4DGfZn8ZmxbHJ/mwe.thy\">mwe.thy</a><br>\n<em>Disclaimer:</em> The implementation does not really make sense but adequately represents our setup.</p>",
        "id": 569251949,
        "sender_full_name": "Alexandra Graß",
        "timestamp": 1769001494
    }
]