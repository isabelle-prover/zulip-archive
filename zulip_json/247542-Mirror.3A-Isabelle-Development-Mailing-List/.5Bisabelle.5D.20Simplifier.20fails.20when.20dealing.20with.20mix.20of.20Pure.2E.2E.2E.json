[
    {
        "content": "<p><strong>From:</strong> Lawrence Paulson via isabelle-dev &lt;<a href=\"mailto:isabelle-dev@mailman.proof.cit.tum.de\">isabelle-dev@mailman.proof.cit.tum.de</a>&gt;</p>\n<p>I made a little search. There are 115 occurrences of \"simproc del: defined_all\" in the distribution and AFP. I'm not sure what this thing does but perhaps it needs urgent attention.</p>\n<p>Larry</p>\n<blockquote>\n<p>On 28 Nov 2025, at 11:00, Manuel Eberl &lt;<a href=\"mailto:manuel@pruvisto.org\">manuel@pruvisto.org</a>&gt; wrote:</p>\n<p>This doesn't look like intended behaviour to me. I tracked the problem to the \"defined_all\" simproc, specifically to the ML function \"Quantifier1.rearrange_all\". If you remove that simproc from the simpset, the exception does not occur.</p>\n<p>Perhaps this helps somebody who knows that part of the code understand what is going on.<br>\n</p>\n</blockquote>",
        "id": 560797877,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764339796
    },
    {
        "content": "<p><strong>From:</strong> Lawrence Paulson via isabelle-dev &lt;<a href=\"mailto:isabelle-dev@mailman.proof.cit.tum.de\">isabelle-dev@mailman.proof.cit.tum.de</a>&gt;</p>\n<p>I think the exception is coming from a low-level function called yield_singleton, which is called by the version of prove_conv in Provers/quantifier1.ML. Several of the simprocs there contain the snippet</p>\n<p>SOME (prove_conv ctxt …) </p>\n<p>and each of these could raise exception List.Empty, which would not be caught and would blow up at the top level.</p>\n<p>So if it is not too late, I propose adding an exception handler to each </p>\n<p>handle List.Empty =&gt; NONE.</p>\n<p>Larry</p>\n<blockquote>\n<p>On 28 Nov 2025, at 11:00, Manuel Eberl &lt;<a href=\"mailto:manuel@pruvisto.org\">manuel@pruvisto.org</a>&gt; wrote:</p>\n<p>This doesn't look like intended behaviour to me. I tracked the problem to the \"defined_all\" simproc, specifically to the ML function \"Quantifier1.rearrange_all\". If you remove that simproc from the simpset, the exception does not occur.</p>\n<p>Perhaps this helps somebody who knows that part of the code understand what is going on.<br>\n</p>\n</blockquote>",
        "id": 560802484,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764341315
    },
    {
        "content": "<p><strong>From:</strong> Manuel Eberl &lt;<a href=\"mailto:manuel@pruvisto.org\">manuel@pruvisto.org</a>&gt;</p>\n<p>Unless I am very mistaken, it's fairly clear that the superficial issue <br>\nis that Quantifier1.rearrange_all sets up a goal and then tries to prove <br>\nit with the tactic \"prove_one_point_All_tac\", which fails. The code is <br>\nwritten in such a way that this is expected to never fail. But it does.</p>\n<p>As for the root issue causing this failure, looked at the code in some <br>\ndetail and strongly suspect that the tactic relies on being able to <br>\natomize the entire goal, i.e. convert any meta-logical operators or <br>\nquantifiers into their HOL equivalents. Once you have something in your <br>\ngoal that cannot be atomised (like your \"PROP P\"), this of course fails.</p>\n<p>Some evidence that this is the case: You can trigger the same behaviour <br>\nby putting a \"PROP U\" in the goal:</p>\n<blockquote>\n<p>lemma ‹⋀x. (x = y) ∧ z ⟹ PROP U›<br>\n  apply simp</p>\n</blockquote>\n<p>My impression is that the simplifier setup for the HOL session is simply <br>\nsomewhat brittle in the presence of things that cannot be atomised. <br>\nWhether that is intended or not I cannot say. Given the prevalence of <br>\nthe \"simproc del\" invocations in the distribution and AFP, it seems that <br>\nit is a known issue and that it does cause problems in real-life <br>\nsituations. So I would say it is at the very least not ideal and one <br>\nshould do something about it.</p>\n<p>The easiest and best way would probably be to simply declare goals that <br>\ncannot be atomised as out of scope for the simproc and make it fail <br>\ngracefully in such cases rather than have such a spectacular crash (as I <br>\nthink Larry suggested). On one hand, I for one don't see how this could <br>\nintroduce any problems (but I am aware that saying this is tempting <br>\nfate). On the other hand, I don't think it is an urgent issue and can <br>\nprobably wait until after the release.</p>\n<p>Incidentally, Florian Haftmann touched this code a few years ago, so <br>\nperhaps he can provide some further insights.</p>\n<p>Cheers,</p>\n<p>Manuel</p>\n<p>On 28/11/2025 16:02, Becker, Hanno wrote:</p>\n<blockquote>\n<p>Thank you, all!</p>\n<p>Larry, can you explain how this relates to the presence of a <code>PROP P</code> term in the goal? Is the simproc somewhere expecting to find all premises of the form <code>HOL.Trueprop ...</code>?</p>\n<p>Best,<br>\nHanno</p>\n<p>﻿On 28/11/2025, 14:51, \"Lawrence Paulson\" &lt;<a href=\"mailto:lp15@cam.ac.uk\">lp15@cam.ac.uk</a> &lt;mailto:<a href=\"mailto:lp15@cam.ac.uk\">lp15@cam.ac.uk</a>&gt;&gt; wrote:</p>\n<p>CAUTION: This email originated from outside of the organization. Do not click links or open attachments unless you can confirm the sender and know the content is safe.</p>\n<p>I think the exception is coming from a low-level function called yield_singleton, which is called by the version of prove_conv in Provers/quantifier1.ML. Several of the simprocs there contain the snippet</p>\n<p>SOME (prove_conv ctxt …)</p>\n<p>and each of these could raise exception List.Empty, which would not be caught and would blow up at the top level.</p>\n<p>So if it is not too late, I propose adding an exception handler to each</p>\n<p>handle List.Empty =&gt; NONE.</p>\n<p>Larry</p>\n<blockquote>\n<p>On 28 Nov 2025, at 11:00, Manuel Eberl &lt;<a href=\"mailto:manuel@pruvisto.org\">manuel@pruvisto.org</a> &lt;mailto:<a href=\"mailto:manuel@pruvisto.org\">manuel@pruvisto.org</a>&gt;&gt; wrote:</p>\n<p>This doesn't look like intended behaviour to me. I tracked the problem to the \"defined_all\" simproc, specifically to the ML function \"Quantifier1.rearrange_all\". If you remove that simproc from the simpset, the exception does not occur.</p>\n<p>Perhaps this helps somebody who knows that part of the code understand what is going on.<br>\n</p>\n</blockquote>\n</blockquote>",
        "id": 560812458,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764344211
    },
    {
        "content": "<p><strong>From:</strong> Makarius &lt;<a href=\"mailto:makarius@sketis.net\">makarius@sketis.net</a>&gt;</p>\n<p>On 28/11/2025 15:22, Lawrence Paulson via isabelle-dev wrote:</p>\n<blockquote>\n<p>I made a little search. There are 115 occurrences of \"simproc del: defined_all\" in the distribution and AFP. I'm not sure what this thing does but perhaps it needs urgent attention.</p>\n</blockquote>\n<p>It has been there for 5 years already, so nothing is urgent here in terms of <br>\nthe Isabelle2025-1 release.</p>\n<p>A proper stable release requires some discipline.</p>\n<p>Makarius</p>",
        "id": 560812460,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764344211
    },
    {
        "content": "<p><strong>From:</strong> Lawrence Paulson via isabelle-dev &lt;<a href=\"mailto:isabelle-dev@mailman.proof.cit.tum.de\">isabelle-dev@mailman.proof.cit.tum.de</a>&gt;</p>\n<p>I tested a patch a little bit. If we catch the exception, the simplifier still fails (as one would expect). The warning \"cannot atomize goal\" no longer appears. For some reason, “apply simp?” still fails.</p>\n<p>I investigated one theory where defined_all is suppressed (Auth/Guard/P1). From what I can tell, the reason was to keep the proof working as before and not that it was generating some sort of error.</p>\n<p>Larry</p>\n<blockquote>\n<p>On 28 Nov 2025, at 15:36, Manuel Eberl &lt;<a href=\"mailto:manuel@pruvisto.org\">manuel@pruvisto.org</a>&gt; wrote:</p>\n<p>The easiest and best way would probably be to simply declare goals that cannot be atomised as out of scope for the simproc and make it fail gracefully in such cases rather than have such a spectacular crash (as I think Larry suggested). On one hand, I for one don't see how this could introduce any problems (but I am aware that saying this is tempting fate). On the other hand, I don't think it is an urgent issue and can probably wait until after the release.</p>\n</blockquote>",
        "id": 560814593,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764344858
    },
    {
        "content": "<p><strong>From:</strong> Makarius &lt;<a href=\"mailto:makarius@sketis.net\">makarius@sketis.net</a>&gt;</p>\n<p>On 28/11/2025 16:47, Lawrence Paulson via isabelle-dev wrote:</p>\n<blockquote>\n<p>I tested a patch a little bit. If we catch the exception, the simplifier still fails (as one would expect). The warning \"cannot atomize goal\" no longer appears. For some reason, “apply simp?” still fails.</p>\n</blockquote>\n<p>Please, no adhoc patches or \"big fixes\", which are usually wrong. I've spent <br>\nso many decades sorting out problems introduced by presumed \"fixes\".</p>\n<p>Step 0 is to use induction over the history of the sources (using \"hg <br>\nbisect\"). It reveals this notable point:</p>\n<p>The first bad revision is:<br>\nchangeset:   71989:bad75618fb82<br>\nuser:        haftmann<br>\ndate:        Thu Jul 02 12:10:58 2020 +0000<br>\nsummary:     extraction of equations x = t from premises beneath meta-all</p>\n<p>This change is not immediately obvious, it belongs to a greater context.</p>\n<p>Step 1 is to show this to the author, Florian Haftmann, in order to amend, <br>\nfinish, improve on it.</p>\n<p>(It is certainly not relevant for the Isabelle2025-1 release, as a <br>\nnon-regression from previous releases.)</p>\n<p>Makarius</p>",
        "id": 560853328,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764363175
    },
    {
        "content": "<p><strong>From:</strong> Makarius &lt;<a href=\"mailto:makarius@sketis.net\">makarius@sketis.net</a>&gt;</p>\n<p>On 28/11/2025 21:51, Makarius wrote:</p>\n<blockquote>\n<p>The first bad revision is:<br>\nchangeset:   71989:bad75618fb82<br>\nuser:        haftmann<br>\ndate:        Thu Jul 02 12:10:58 2020 +0000<br>\nsummary:     extraction of equations x = t from premises beneath meta-all</p>\n</blockquote>\n<p>See also this NEWS entry from Isabelle2021:</p>\n<ul>\n<li>\n<p>Simproc \"defined_all\" and rewrite rule \"subst_all\" perform more<br>\naggressive substitution with variables from assumptions.<br>\nINCOMPATIBILITY, consider repairing proofs locally like this:</p>\n<p>supply subst_all [simp del] [[simproc del: defined_all]]</p>\n</li>\n</ul>\n<p>Which means that in these terms, the example by Hanno is \"broken\".</p>\n<p>It is up to discussion, together with Florian, if this is good or bad. But we <br>\ncan definitely close the case as something urgent to be \"fixed\".</p>\n<p>Makarius</p>",
        "id": 560853861,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764363574
    },
    {
        "content": "<p><strong>From:</strong> Florian Haftmann &lt;<a href=\"mailto:florian.haftmann@cit.tum.de\">florian.haftmann@cit.tum.de</a>&gt;</p>\n<p>Hi all,</p>\n<p>Am 28.11.25 um 21:59 schrieb Makarius:</p>\n<blockquote>\n<p>On 28/11/2025 21:51, Makarius wrote:</p>\n<blockquote>\n<p>The first bad revision is:<br>\nchangeset:   71989:bad75618fb82<br>\nuser:        haftmann<br>\ndate:        Thu Jul 02 12:10:58 2020 +0000<br>\nsummary:     extraction of equations x = t from premises beneath meta-all</p>\n</blockquote>\n<p>See also this NEWS entry from Isabelle2021:</p>\n</blockquote>\n<p>Am 28.11.25 um 16:36 schrieb Manuel Eberl:</p>\n<blockquote>\n<p>As for the root issue causing this failure, looked at the code in some<br>\ndetail and strongly suspect that the tactic relies on being able to<br>\natomize the entire goal, i.e. convert any meta-logical operators or<br>\nquantifiers into their HOL equivalents. Once you have something in your<br>\ngoal that cannot be atomised (like your \"PROP P\"), this of course fails.</p>\n<p>Some evidence that this is the case: You can trigger the same behaviour<br>\nby putting a \"PROP U\" in the goal:</p>\n<blockquote>\n<p>lemma ‹⋀x. (x = y) ∧ z ⟹ PROP U›<br>\n  apply simp</p>\n</blockquote>\n</blockquote>\n<p>Thanks for investigating it.</p>\n<p>As far as I remember, this was a suggestion by Tobias to generalize a <br>\nmechanism from ∀ to ⋀. For some reason ever I derived <br>\nprove_one_point_all_tac from prove_one_point_All_tac using atomization, <br>\nbut as the example shows, this has been misleading.</p>\n<p>I’ll investigate this (maybe not in this year) and see whether the <br>\natomization can be dropped or whether at least the simproc can fail <br>\ngracefully then.</p>\n<p>Am 28.11.25 um 15:22 schrieb Lawrence Paulson via isabelle-dev:</p>\n<blockquote>\n<p>I made a little search. There are 115 occurrences of \"simproc del: <br>\ndefined_all\" in the distribution and AFP. I'm not sure what this thing <br>\ndoes but perhaps it needs urgent attention.</p>\n</blockquote>\n<p>These sporadic simproc del: occur in apply-style proofs and have been <br>\ninserted to avoid refactoring them; they are unconnected to the <br>\nimplementation problem (it would be extremely strange if I had ignored <br>\nthe problem if I had encountered it while adjusting proofs).</p>\n<p>Cheers,<br>\n    Florian</p>\n<p><a href=\"/user_uploads/14278/5bkFZEPFzQFQheFhfvRbKpIH/OpenPGP_0xA707172232CFA4E9.asc\">OpenPGP_0xA707172232CFA4E9.asc</a><br>\n<a href=\"/user_uploads/14278/-uOPpGlv86gZMeBgs_omYk6M/OpenPGP_signature.asc\">OpenPGP_signature.asc</a></p>",
        "id": 561845567,
        "sender_full_name": "Email Gateway",
        "timestamp": 1764845243
    }
]