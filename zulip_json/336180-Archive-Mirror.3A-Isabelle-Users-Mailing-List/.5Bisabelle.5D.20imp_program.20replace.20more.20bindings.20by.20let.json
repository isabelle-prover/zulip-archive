[
    {
        "content": "<p>From: Mathias Fleury &lt;<a href=\"mailto:mathias.fleury12@gmail.com\">mathias.fleury12@gmail.com</a>&gt;<br>\nDear code-generator experts,</p>\n<p>does anyone understand the code and the assumptions of the function imp_program (used for example by the code target SML_imp)? Currently, it is able to replace some of the (fn f_ =&gt; fn () =&gt; f_ args) by lets, but not in every case.</p>\n<p>For example, consider the following variant of the identity function:</p>\n<p>definition f1 where<br>\n  ‹f1 n = (if False then do {a ← return n; return a} else return n)›</p>\n<p>The code can be exported by<br>\nexport_code f1 in SML_imp</p>\n<p>Readable code is produced:</p>\n<p>fun f1 (A1_, A2_) n =<br>\n  (if false<br>\n    then (fn () =&gt;<br>\n           let<br>\n             val x = n;<br>\n           in<br>\n             x<br>\n           end)<br>\n    else (fn () =&gt; n));</p>\n<p>However, if I change the definition by adding a return at the end of the function:</p>\n<p>definition f2 where<br>\n  ‹f2 n = (if False then  do {a ← return n; return a} else return n) ⤜ return›</p>\n<p>Then the exported code is less readable:</p>\n<p>fun f2 (A1_, A2_) n =<br>\n  (fn () =&gt;<br>\n    let<br>\n      val x =<br>\n        (if false<br>\n          then  (fn f_ =&gt; fn () =&gt; f_ ((fn () =&gt; n) ()) ())<br>\n                 (fn a =&gt; (fn () =&gt; a))<br>\n          else (fn () =&gt; n))<br>\n          ();<br>\n    in<br>\n      x<br>\n    end);</p>\n<p>This kind of code appears frequently in the code I generate with the Refinement Framework, because of while-loops. An extreme version of this behaviour can be found in the code generated from my verified SAT solver <a href=\"https://bitbucket.org/isafol/isafol/src/020eeeda9228b809b1977bc54b5fa853c5a8ef14/Weidenbach_Book/code/IsaSAT_solver.sml?at=master&amp;fileviewer=file-view-default#IsaSAT_solver.sml-1720\">https://bitbucket.org/isafol/isafol/src/020eeeda9228b809b1977bc54b5fa853c5a8ef14/Weidenbach_Book/code/IsaSAT_solver.sml?at=master&amp;fileviewer=file-view-default#IsaSAT_solver.sml-1720</a> &lt;<a href=\"https://bitbucket.org/isafol/isafol/src/020eeeda9228b809b1977bc54b5fa853c5a8ef14/Weidenbach_Book/code/IsaSAT_solver.sml?at=master&amp;fileviewer=file-view-default#IsaSAT_solver.sml-1720\">https://bitbucket.org/isafol/isafol/src/020eeeda9228b809b1977bc54b5fa853c5a8ef14/Weidenbach_Book/code/IsaSAT_solver.sml?at=master&amp;fileviewer=file-view-default#IsaSAT_solver.sml-1720</a>&gt;. Changing this behaviour would improve readability, make it easier for me to try how changes perform before verifying them in Isabelle, and make it easier to see if there are performance bugs in my code, like copying of arrays.</p>\n<p>I know of a workaround: giving a name to ‹do {a ← return n; return a}› works.</p>\n<p>By looking at the code of imp_monad_bind/imp_monad_bind' in SML_imp and comparing the calls for ICase (imp_monad_bind') and functions (imp_monad_bind'), I believe that</p>\n<p>imp_monad_bind'' [(t1, ty1), (t2, ty2)]</p>\n<p>is missing recursive calls and could be:</p>\n<p>imp_monad_bind'' [(imp_monad_bind t1, ty1), (imp_monad_bind t2, ty2)]</p>\n<p>However,</p>\n<p>1. this change might make the code generator unsound. I don't know what assumptions are made here.<br>\n  2. this change prevents the grouping of lets to happen:</p>\n<p>definition f3 where<br>\n  ‹f3 n = (if False then  do {a ← return n; a ← return n; return a} else return n)›</p>\n<p>now gets:</p>\n<p>fun f3 (A1_, A2_) n =<br>\n  (if false<br>\n    then (fn () =&gt;<br>\n           let<br>\n             val _ =  n;<br>\n           in<br>\n             (fn () =&gt;<br>\n               let<br>\n                 val x = n;<br>\n               in<br>\n                 x<br>\n               end)<br>\n               ()<br>\n           end)<br>\n    else (fn () =&gt; n));</p>\n<p>instead of</p>\n<p>fun f3 (A1_, A2_) n =<br>\n  (if false<br>\n    then (fn () =&gt;<br>\n           let<br>\n             val _ = n;<br>\n             val x = n;<br>\n           in<br>\n             x<br>\n           end)<br>\n    else (fn () =&gt; n));</p>\n<p>Best,<br>\nMathias</p>",
        "id": 294726982,
        "sender_full_name": "Email Gateway",
        "timestamp": 1661186726
    },
    {
        "content": "<p>From: Florian Haftmann &lt;<a href=\"mailto:florian.haftmann@informatik.tu-muenchen.de\">florian.haftmann@informatik.tu-muenchen.de</a>&gt;<br>\nDear Mathias,</p>\n<blockquote>\n<p>does anyone understand the code and the assumptions of the function imp_program (used for example by the code target SML_imp)? Currently, it is able to replace some of the (fn f_ =&gt; fn () =&gt; f_ args) by lets, but not in every case.<br>\nwell, imp_monad_bind is a transformation on expressions of the code<br>\ngeneration intermediate language and imp_program lifts that to transform<br>\nwhole programs of the code generation intermediate language.</p>\n</blockquote>\n<p>As is always the case with such extra-logical transformations, they are<br>\nerror-prone; most of this code goes back to the first<br>\n(over-)enthusiastic Imperative-HOL experiments in 2008 (rev.<br>\n54bf1fea9252) and has only been changed in cases of urgent need.</p>\n<blockquote>\n<blockquote>\n<p>By looking at the code of imp_monad_bind/imp_monad_bind' in SML_imp and comparing the calls for ICase (imp_monad_bind') and functions (imp_monad_bind'), I believe that</p>\n<p>imp_monad_bind'' [(t1, ty1), (t2, ty2)]</p>\n<p>is missing recursive calls and could be:</p>\n<p>imp_monad_bind'' [(imp_monad_bind t1, ty1), (imp_monad_bind t2, ty2)]</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>1. this change might make the code generator unsound. I don't know what assumptions are made here.</p>\n</blockquote>\n</blockquote>\n<p>Since imp_monad_bind is supposed to be semantic-preserving, it could be<br>\nassumed that the recursive calls are safe.</p>\n<blockquote>\n<blockquote>\n<p>2. this change prevents the grouping of lets to happen:</p>\n</blockquote>\n</blockquote>\n<p>It is indeed hard to tell on the spot how this could be resolved.</p>\n<p>Cheers,<br>\n    Florian<br>\n<a href=\"/user_uploads/14278/i5wKxRJNu0dh6sT2EreAfPc7/signature.asc\">signature.asc</a></p>",
        "id": 294728198,
        "sender_full_name": "Email Gateway",
        "timestamp": 1661187100
    }
]